<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Automatonymous | MassTransit</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#3a0839">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="description" content="A free, open-source distributed application framework for .NET.">
    <meta name="msapplication-TileColor" content="#3a0839">
    <meta name="msapplication-config" content="/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    
    <link rel="preload" href="/assets/css/0.styles.af8ca635.css" as="style"><link rel="preload" href="/assets/js/app.0f717998.js" as="script"><link rel="preload" href="/assets/js/3.da322882.js" as="script"><link rel="preload" href="/assets/js/136.c0914ec3.js" as="script"><link rel="prefetch" href="/assets/js/10.941c3d0b.js"><link rel="prefetch" href="/assets/js/100.23f1c4ea.js"><link rel="prefetch" href="/assets/js/101.710aa7a5.js"><link rel="prefetch" href="/assets/js/102.827dba0e.js"><link rel="prefetch" href="/assets/js/103.fdd173f3.js"><link rel="prefetch" href="/assets/js/104.8c1a005f.js"><link rel="prefetch" href="/assets/js/105.95990127.js"><link rel="prefetch" href="/assets/js/106.c4b2015b.js"><link rel="prefetch" href="/assets/js/107.e0acc6f2.js"><link rel="prefetch" href="/assets/js/108.78eab687.js"><link rel="prefetch" href="/assets/js/109.b4d1a487.js"><link rel="prefetch" href="/assets/js/11.76406285.js"><link rel="prefetch" href="/assets/js/110.f0a83b63.js"><link rel="prefetch" href="/assets/js/111.3f22952e.js"><link rel="prefetch" href="/assets/js/112.1ad12ad5.js"><link rel="prefetch" href="/assets/js/113.40368044.js"><link rel="prefetch" href="/assets/js/114.3cd980b4.js"><link rel="prefetch" href="/assets/js/115.00f2166d.js"><link rel="prefetch" href="/assets/js/116.6670b5f2.js"><link rel="prefetch" href="/assets/js/117.4a42c861.js"><link rel="prefetch" href="/assets/js/118.e6410316.js"><link rel="prefetch" href="/assets/js/119.dd058ee6.js"><link rel="prefetch" href="/assets/js/12.4464da33.js"><link rel="prefetch" href="/assets/js/120.cccb363a.js"><link rel="prefetch" href="/assets/js/121.75e3ed75.js"><link rel="prefetch" href="/assets/js/122.ddb3d7e5.js"><link rel="prefetch" href="/assets/js/123.f7ca23b1.js"><link rel="prefetch" href="/assets/js/124.2e501680.js"><link rel="prefetch" href="/assets/js/125.4d5eeb88.js"><link rel="prefetch" href="/assets/js/126.6c0ed471.js"><link rel="prefetch" href="/assets/js/127.6d232467.js"><link rel="prefetch" href="/assets/js/128.7a780f23.js"><link rel="prefetch" href="/assets/js/129.7fda41f1.js"><link rel="prefetch" href="/assets/js/13.512e3537.js"><link rel="prefetch" href="/assets/js/130.19738da2.js"><link rel="prefetch" href="/assets/js/131.6e3916b7.js"><link rel="prefetch" href="/assets/js/132.bdf944d1.js"><link rel="prefetch" href="/assets/js/133.bf0cdaf4.js"><link rel="prefetch" href="/assets/js/134.a24e70f8.js"><link rel="prefetch" href="/assets/js/135.3087f6fe.js"><link rel="prefetch" href="/assets/js/137.adc2c79a.js"><link rel="prefetch" href="/assets/js/138.6300f157.js"><link rel="prefetch" href="/assets/js/139.b2f14afc.js"><link rel="prefetch" href="/assets/js/14.f3f541c4.js"><link rel="prefetch" href="/assets/js/140.66174436.js"><link rel="prefetch" href="/assets/js/141.548ac70e.js"><link rel="prefetch" href="/assets/js/142.31e46e2f.js"><link rel="prefetch" href="/assets/js/143.e450e37e.js"><link rel="prefetch" href="/assets/js/144.1a7bdf49.js"><link rel="prefetch" href="/assets/js/145.8bd22f33.js"><link rel="prefetch" href="/assets/js/146.e9cae417.js"><link rel="prefetch" href="/assets/js/147.99c43782.js"><link rel="prefetch" href="/assets/js/148.0001e2e5.js"><link rel="prefetch" href="/assets/js/149.8dd98593.js"><link rel="prefetch" href="/assets/js/15.5b1e58a2.js"><link rel="prefetch" href="/assets/js/150.576d606c.js"><link rel="prefetch" href="/assets/js/151.7ffc60f8.js"><link rel="prefetch" href="/assets/js/152.64603d5f.js"><link rel="prefetch" href="/assets/js/153.04273ceb.js"><link rel="prefetch" href="/assets/js/154.5ecb1789.js"><link rel="prefetch" href="/assets/js/155.2443a17f.js"><link rel="prefetch" href="/assets/js/156.89bc3ef2.js"><link rel="prefetch" href="/assets/js/157.d2092780.js"><link rel="prefetch" href="/assets/js/158.abc54fe2.js"><link rel="prefetch" href="/assets/js/159.f591dba4.js"><link rel="prefetch" href="/assets/js/16.b89c7882.js"><link rel="prefetch" href="/assets/js/17.8a846d9a.js"><link rel="prefetch" href="/assets/js/18.bd1ec876.js"><link rel="prefetch" href="/assets/js/19.00d1434f.js"><link rel="prefetch" href="/assets/js/20.384b5b5b.js"><link rel="prefetch" href="/assets/js/21.b1ed6e3f.js"><link rel="prefetch" href="/assets/js/22.f8fa29a7.js"><link rel="prefetch" href="/assets/js/23.d5d8e28e.js"><link rel="prefetch" href="/assets/js/24.0e4be943.js"><link rel="prefetch" href="/assets/js/25.d7ae1021.js"><link rel="prefetch" href="/assets/js/26.d7c52843.js"><link rel="prefetch" href="/assets/js/27.b8504be5.js"><link rel="prefetch" href="/assets/js/28.318c6322.js"><link rel="prefetch" href="/assets/js/29.eb49e807.js"><link rel="prefetch" href="/assets/js/30.9ff31a8a.js"><link rel="prefetch" href="/assets/js/31.f9836bae.js"><link rel="prefetch" href="/assets/js/32.4306b1f2.js"><link rel="prefetch" href="/assets/js/33.3cbf102a.js"><link rel="prefetch" href="/assets/js/34.82ea42b8.js"><link rel="prefetch" href="/assets/js/35.a4cf4586.js"><link rel="prefetch" href="/assets/js/36.c79bc776.js"><link rel="prefetch" href="/assets/js/37.93848c0f.js"><link rel="prefetch" href="/assets/js/38.aed8b2f5.js"><link rel="prefetch" href="/assets/js/39.0bd57e5e.js"><link rel="prefetch" href="/assets/js/4.37ee6b06.js"><link rel="prefetch" href="/assets/js/40.8a1415b1.js"><link rel="prefetch" href="/assets/js/41.d49c2efb.js"><link rel="prefetch" href="/assets/js/42.b7bbbaf6.js"><link rel="prefetch" href="/assets/js/43.87609deb.js"><link rel="prefetch" href="/assets/js/44.cee9abc3.js"><link rel="prefetch" href="/assets/js/45.55c4b4b6.js"><link rel="prefetch" href="/assets/js/46.fc3df9fc.js"><link rel="prefetch" href="/assets/js/47.126380a2.js"><link rel="prefetch" href="/assets/js/48.345456c9.js"><link rel="prefetch" href="/assets/js/49.cb212764.js"><link rel="prefetch" href="/assets/js/5.9fe86136.js"><link rel="prefetch" href="/assets/js/50.e2a625b8.js"><link rel="prefetch" href="/assets/js/51.a2301d85.js"><link rel="prefetch" href="/assets/js/52.7626f76b.js"><link rel="prefetch" href="/assets/js/53.6dcfb078.js"><link rel="prefetch" href="/assets/js/54.7d5b7906.js"><link rel="prefetch" href="/assets/js/55.2f161720.js"><link rel="prefetch" href="/assets/js/56.3baf6838.js"><link rel="prefetch" href="/assets/js/57.5952a2e8.js"><link rel="prefetch" href="/assets/js/58.35bd50d1.js"><link rel="prefetch" href="/assets/js/59.1a61c98b.js"><link rel="prefetch" href="/assets/js/6.ae895e4f.js"><link rel="prefetch" href="/assets/js/60.dde8f8f2.js"><link rel="prefetch" href="/assets/js/61.fc9b4fc0.js"><link rel="prefetch" href="/assets/js/62.a5b28645.js"><link rel="prefetch" href="/assets/js/63.16221e1a.js"><link rel="prefetch" href="/assets/js/64.573d11a6.js"><link rel="prefetch" href="/assets/js/65.0082a727.js"><link rel="prefetch" href="/assets/js/66.366ffe6e.js"><link rel="prefetch" href="/assets/js/67.2271d873.js"><link rel="prefetch" href="/assets/js/68.6cfc25bd.js"><link rel="prefetch" href="/assets/js/69.f91f0dae.js"><link rel="prefetch" href="/assets/js/7.77650bb5.js"><link rel="prefetch" href="/assets/js/70.9f842d94.js"><link rel="prefetch" href="/assets/js/71.f12cfc74.js"><link rel="prefetch" href="/assets/js/72.7c699f2b.js"><link rel="prefetch" href="/assets/js/73.2080b9dd.js"><link rel="prefetch" href="/assets/js/74.03ec3239.js"><link rel="prefetch" href="/assets/js/75.a2e95397.js"><link rel="prefetch" href="/assets/js/76.a8f91599.js"><link rel="prefetch" href="/assets/js/77.bb549269.js"><link rel="prefetch" href="/assets/js/78.56c8d184.js"><link rel="prefetch" href="/assets/js/79.99f38c6f.js"><link rel="prefetch" href="/assets/js/8.be925209.js"><link rel="prefetch" href="/assets/js/80.13f11752.js"><link rel="prefetch" href="/assets/js/81.028a7b5e.js"><link rel="prefetch" href="/assets/js/82.4956e61b.js"><link rel="prefetch" href="/assets/js/83.4efd0d82.js"><link rel="prefetch" href="/assets/js/84.e214e198.js"><link rel="prefetch" href="/assets/js/85.c935478c.js"><link rel="prefetch" href="/assets/js/86.bd6a9d11.js"><link rel="prefetch" href="/assets/js/87.47bd24e2.js"><link rel="prefetch" href="/assets/js/88.350bbf5d.js"><link rel="prefetch" href="/assets/js/89.32d2e3c2.js"><link rel="prefetch" href="/assets/js/9.b8c411bf.js"><link rel="prefetch" href="/assets/js/90.e0e9e669.js"><link rel="prefetch" href="/assets/js/91.a2c133e3.js"><link rel="prefetch" href="/assets/js/92.00ca9d52.js"><link rel="prefetch" href="/assets/js/93.70dcdd49.js"><link rel="prefetch" href="/assets/js/94.861c48fb.js"><link rel="prefetch" href="/assets/js/95.352fd642.js"><link rel="prefetch" href="/assets/js/96.e303cfc4.js"><link rel="prefetch" href="/assets/js/97.b5c87e83.js"><link rel="prefetch" href="/assets/js/98.1d3e5253.js"><link rel="prefetch" href="/assets/js/99.a0f7babd.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.ceb48f17.js">
    <link rel="stylesheet" href="/assets/css/0.styles.af8ca635.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/mt-logo-small.png" alt="MassTransit" class="logo"> <span class="site-name can-hide">MassTransit</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/discord.html" class="nav-link">
  Discord
</a></div><div class="nav-item"><a href="https://nuget.org/packages/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NuGet
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/discord.html" class="nav-link">
  Discord
</a></div><div class="nav-item"><a href="https://nuget.org/packages/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NuGet
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/getting-started/" class="sidebar-heading clickable"><span>Getting Started</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/getting-started/upgrade-v6.html" class="sidebar-link">Upgrading</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/releases/" class="sidebar-heading clickable"><span>Release Notes</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/usage/" class="sidebar-heading clickable router-link-active open"><span>Using MassTransit</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/usage/configuration.html" class="sidebar-link">Configuration</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/transports/" class="sidebar-heading clickable"><span>Transports</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/riders/" class="sidebar-heading clickable"><span>Riders</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/faas/" class="sidebar-heading clickable"><span>FaaS</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/usage/mediator.html" class="sidebar-link">Mediator</a></li><li><a href="/usage/messages.html" class="sidebar-link">Messages</a></li><li><a href="/usage/consumers.html" class="sidebar-link">Consumers</a></li><li><a href="/usage/producers.html" class="sidebar-link">Producers</a></li><li><a href="/usage/exceptions.html" class="sidebar-link">Exceptions</a></li><li><a href="/usage/requests.html" class="sidebar-link">Requests</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/sagas/" class="sidebar-heading clickable router-link-active open"><span>Sagas</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/usage/sagas/automatonymous.html" aria-current="page" class="active sidebar-link">Automatonymous</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/usage/sagas/automatonymous.html#introduction" class="sidebar-link">Introduction</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/usage/sagas/automatonymous.html#state-machine" class="sidebar-link">State Machine</a></li><li class="sidebar-sub-header"><a href="/usage/sagas/automatonymous.html#instance" class="sidebar-link">Instance</a></li><li class="sidebar-sub-header"><a href="/usage/sagas/automatonymous.html#state" class="sidebar-link">State</a></li><li class="sidebar-sub-header"><a href="/usage/sagas/automatonymous.html#event" class="sidebar-link">Event</a></li><li class="sidebar-sub-header"><a href="/usage/sagas/automatonymous.html#behavior" class="sidebar-link">Behavior</a></li><li class="sidebar-sub-header"><a href="/usage/sagas/automatonymous.html#configuration" class="sidebar-link">Configuration</a></li></ul></li><li class="sidebar-sub-header"><a href="/usage/sagas/automatonymous.html#event-2" class="sidebar-link">Event</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/usage/sagas/automatonymous.html#ignore-event" class="sidebar-link">Ignore Event</a></li><li class="sidebar-sub-header"><a href="/usage/sagas/automatonymous.html#composite-event" class="sidebar-link">Composite Event</a></li><li class="sidebar-sub-header"><a href="/usage/sagas/automatonymous.html#missing-instance" class="sidebar-link">Missing Instance</a></li><li class="sidebar-sub-header"><a href="/usage/sagas/automatonymous.html#initial-insert" class="sidebar-link">Initial Insert</a></li><li class="sidebar-sub-header"><a href="/usage/sagas/automatonymous.html#completed-instance" class="sidebar-link">Completed Instance</a></li></ul></li><li class="sidebar-sub-header"><a href="/usage/sagas/automatonymous.html#activities" class="sidebar-link">Activities</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/usage/sagas/automatonymous.html#publish" class="sidebar-link">Publish</a></li><li class="sidebar-sub-header"><a href="/usage/sagas/automatonymous.html#send" class="sidebar-link">Send</a></li><li class="sidebar-sub-header"><a href="/usage/sagas/automatonymous.html#respond" class="sidebar-link">Respond</a></li><li class="sidebar-sub-header"><a href="/usage/sagas/automatonymous.html#schedule" class="sidebar-link">Schedule</a></li><li class="sidebar-sub-header"><a href="/usage/sagas/automatonymous.html#request" class="sidebar-link">Request</a></li><li class="sidebar-sub-header"><a href="/usage/sagas/automatonymous.html#custom" class="sidebar-link">Custom</a></li></ul></li></ul></li><li><a href="/usage/sagas/consumer-saga.html" class="sidebar-link">Consumer Sagas</a></li><li><section class="sidebar-group is-sub-group depth-2"><a href="/usage/sagas/persistence" class="sidebar-heading clickable"><span>Persistence</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/usage/sagas/azure-table.html" class="sidebar-link">Azure Table</a></li><li><a href="/usage/sagas/cosmos.html" class="sidebar-link">Cosmos DB</a></li><li><a href="/usage/sagas/dapper.html" class="sidebar-link">Dapper</a></li><li><a href="/usage/sagas/ef.html" class="sidebar-link">Entity Framework</a></li><li><a href="/usage/sagas/efcore.html" class="sidebar-link">Entity Framework Core</a></li><li><a href="/usage/sagas/marten.html" class="sidebar-link">Marten</a></li><li><a href="/usage/sagas/mongodb.html" class="sidebar-link">MongoDB</a></li><li><a href="/usage/sagas/nhibernate.html" class="sidebar-link">NHibernate</a></li><li><a href="/usage/sagas/redis.html" class="sidebar-link">Redis</a></li><li><a href="/usage/sagas/session.html" class="sidebar-link">Azure Service Bus</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/containers/" class="sidebar-heading clickable"><span>Containers</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/usage/testing.html" class="sidebar-link">Testing</a></li><li><a href="/usage/logging.html" class="sidebar-link">Logging</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Advanced</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/learn/" class="sidebar-heading clickable"><span>Getting Help</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Articles</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/platform/" class="sidebar-heading clickable"><span>Platform</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Reference</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="automatonymous"><a href="#automatonymous" class="header-anchor">#</a> Automatonymous</h1> <h2 id="introduction"><a href="#introduction" class="header-anchor">#</a> Introduction</h2> <p>Automatonymous is a state machine library for .NET and provides a C# syntax to define a state machine, including states, events, and behaviors. MassTransit includes Automatonymous, and adds instance storage, event correlation, message binding, request and response support, and scheduling.</p> <div class="custom-block tip"><p class="custom-block-title">V8</p> <p>Automatonymous is no longer a separate NuGet package and has been assimilated by <em>MassTransit</em>. In previous versions, an additional package reference was required. If <em>Automatonymous</em> is referenced, that reference must be removed as it is no longer compatible.</p></div> <h3 id="state-machine"><a href="#state-machine" class="header-anchor">#</a> State Machine</h3> <p>A state machine defines the states, events, and behavior of a finite state machine. Implemented as a class, which is derived from <code>MassTransitStateMachine&lt;T&gt;</code>, a state machine is created once, and then used to apply event triggered behavior to state machine <em>instances</em>.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="instance"><a href="#instance" class="header-anchor">#</a> Instance</h3> <p>An instance contains the data for a state machine <em>instance</em>. A new instance is created for every consumed <em>initial</em> event where an existing instance with the same <em>CorrelationId</em> was not found. A saga repository is used to persist instances. Instances are classes, and must implement the <code>SagaStateMachineInstance</code> interface.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderState</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">SagaStateMachineInstance</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> CorrelationId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> CurrentState <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">InstanceState</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>CurrentState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>An instance must store the current state, which can be one of three types:</p> <table><thead><tr><th style="text-align:left;">Type</th> <th style="text-align:left;">Description</th></tr></thead> <tbody><tr><td style="text-align:left;">State</td> <td style="text-align:left;">The interface <code>State</code> type. Can be difficult to serialize, typically only used for in-memory instances, but could be used if the repository storage engine supports mapping user types to a storage type.</td></tr> <tr><td style="text-align:left;">string</td> <td style="text-align:left;">Easy, stores the state name. However, it takes a lot of space as the state name is repeated for every instance.</td></tr> <tr><td style="text-align:left;">int</td> <td style="text-align:left;">Small, fast, but requires that each possible state be specified, in order, to assign <em>int</em> values to each state.</td></tr></tbody></table> <p>The <em>CurrentState</em> instance state property is automatically configured if it is a <code>State</code>. For <code>string</code> or <code>int</code> types, the <code>InstanceState</code> method must be used.</p> <p>To specify the <em>int</em> state values, configure the instance state as shown below.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderState</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">SagaStateMachineInstance</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> CorrelationId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> CurrentState <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">InstanceState</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>CurrentState<span class="token punctuation">,</span> Submitted<span class="token punctuation">,</span> Accepted<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This results in the following values: 0 - None, 1 - Initial, 2 - Final, 3 - Submitted, 4 - Accepted</p> <h3 id="state"><a href="#state" class="header-anchor">#</a> State</h3> <p>States represent previously consumed events resulting in an instance being in a current <em>state</em>. An instance can only be in one state at a given time. A new instance defaults to the <em>Initial</em> state, which is automatically defined. The <em>Final</em> state is also defined for all state machines and is used to signify the instance has reached the final state.</p> <p>In the example, two states are declared. States are automatically initialized by the <em>MassTransitStateMachine</em> base class constructor.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">State</span> Submitted <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">State</span> Accepted <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="event"><a href="#event" class="header-anchor">#</a> Event</h3> <p>An event is something that happened which may result in a state change. An event can add or update instance data, as well as changing an instance's current state. The <code>Event&lt;T&gt;</code> is generic, where <code>T</code> must be a valid message type.</p> <p>In the example below, the <em>SubmitOrder</em> message is declared as an event including how to correlate the event to an instance.</p> <blockquote><p>Unless events implement <code>CorrelatedBy&lt;Guid&gt;</code>, they must be declared with a correlation expression.</p></blockquote> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SubmitOrder</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Event</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> SubmitOrder<span class="token punctuation">,</span> x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token function">CorrelateById</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Event<span class="token punctuation">&lt;</span>SubmitOrder<span class="token punctuation">&gt;</span></span> SubmitOrder <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="behavior"><a href="#behavior" class="header-anchor">#</a> Behavior</h3> <p>Behavior is what happens when an <em>event</em> occurs during a <em>state</em>.</p> <p>Below, the <em>Initially</em> block is used to define the behavior of the <em>SubmitOrder</em> event during the <em>Initial</em> state. When a <em>SubmitOrder</em> message is consumed and an instance with a <em>CorrelationId</em> matching the <em>OrderId</em> is not found, a new instance will be created in the <em>Initial</em> state. The <em>TransitionTo</em> activity transitions the instance to the <em>Submitted</em> state, after which the instance is persisted using the saga repository.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Initially</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Subsequently, the <em>OrderAccepted</em> event could be handled by the behavior shown below.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderAccepted</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Event</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> OrderAccepted<span class="token punctuation">,</span> x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token function">CorrelateById</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">During</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderAccepted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Accepted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Event<span class="token punctuation">&lt;</span>OrderAccepted<span class="token punctuation">&gt;</span></span> OrderAccepted <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="message-order"><a href="#message-order" class="header-anchor">#</a> Message Order</h4> <p>Message brokers typically do not guarantee message order. Therefore, it is important to consider out-of-order messages in state machine design.</p> <p>In the example above, receiving a <em>SubmitOrder</em> message after an <em>OrderAccepted</em> event could cause the <em>SubmitOrder</em> message to end up in the <em>_error</em> queue. If the <em>OrderAccepted</em> event is received first, it would be discarded since it isn't accepted in the <em>Initial</em> state. Below is an updated state machine that handles both of these scenarios.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Initially</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderAccepted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Accepted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">During</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderAccepted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Accepted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">During</span><span class="token punctuation">(</span>Accepted<span class="token punctuation">,</span>
            <span class="token function">Ignore</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>In the updated example, receiving a <em>SubmitOrder</em> message while in an <em>Accepted</em> state ignores the event. However, data in the event may be useful. In that case, adding behavior to copy the data to the instance could be added. Below, data from the event is captured in both scenarios.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SubmitOrder</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token return-type class-name">DateTime</span> OrderDate <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderState</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">SagaStateMachineInstance</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> CorrelationId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> CurrentState <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime<span class="token punctuation">?</span></span> OrderDate <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Initially</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Then</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>OrderDate <span class="token operator">=</span> x<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>OrderDate<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderAccepted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Accepted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">During</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderAccepted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Accepted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">During</span><span class="token punctuation">(</span>Accepted<span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Then</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>OrderDate <span class="token operator">=</span> x<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>OrderDate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="configuration"><a href="#configuration" class="header-anchor">#</a> Configuration</h3> <p>To configure a saga state machine:</p> <div class="language-cs extra-class"><pre class="language-cs"><code>services<span class="token punctuation">.</span><span class="token function">AddMassTransit</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    x<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSagaStateMachine</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderStateMachine<span class="token punctuation">,</span> OrderState<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">InMemorySagaRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The example above uses the in-memory saga repository, but any saga repository could be used. The <a href="/usage/sagas/persistence.html">persistence</a> section includes details on the supported saga repositories.</p> <p>To test the state machine, see the <a href="/usage/testing.html#state-machine-saga">testing</a> section.</p> <h2 id="event-2"><a href="#event-2" class="header-anchor">#</a> Event</h2> <p>As shown above, an event is a message that can be consumed by the state machine. Events can specify any valid message type, and each event may be configured. There are several event configuration methods available.</p> <p>The built-in <code>CorrelatedBy&lt;Guid&gt;</code> interface can be used in a message contract to specify the event <code>CorrelationId</code>.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderCanceled</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">CorrelatedBy<span class="token punctuation">&lt;</span>Guid<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>    
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Event</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> OrderCanceled<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// not required, as it is the default convention</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>While the event is declared explicitly above, it is not required. The default convention will automatically configure events that have a <code>CorrelatedBy&lt;Guid&gt;</code> interface.</p> <p>While convenient, some consider the interface an intrusion of infrastructure to the message contract. MassTransit also supports a declarative approach to specifying the <code>CorrelationId</code> for events. By configuring the global message topology, it is possible to specify a message property to use for correlation.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SubmitOrder</span>
<span class="token punctuation">{</span>    
    <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token comment">// this is shown here, but can be anywhere in the application as long as it executes</span>
    <span class="token comment">// before the state machine instance is created. Startup, etc. is a good place for it.</span>
    <span class="token comment">// It only needs to be called once per process.</span>
    <span class="token keyword">static</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        GlobalTopology<span class="token punctuation">.</span>Send<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">UseCorrelationId</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SubmitOrder<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>OrderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Event</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> SubmitOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Event<span class="token punctuation">&lt;</span>SubmitOrder<span class="token punctuation">&gt;</span></span> SubmitOrder <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>An alternative is to declare the event correlation, as shown below. This should be used when neither of the approaches above are used.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SubmitOrder</span>
<span class="token punctuation">{</span>    
    <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Event</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> SubmitOrder<span class="token punctuation">,</span> x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token function">CorrelateById</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Event<span class="token punctuation">&lt;</span>SubmitOrder<span class="token punctuation">&gt;</span></span> SubmitOrder <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Since <code>OrderId</code> is a <code>Guid</code>, it can be used for event correlation. When <code>SubmitOrder</code> is accepted in the <em>Initial</em> state, and because the <em>OrderId</em> is a <em>Guid</em>, the <code>CorrelationId</code> on the new instance is automatically assigned the <em>OrderId</em> value.</p> <p>Events can also be correlated using a query expression, which is required when events are not correlated to the instance's <em>CorrelationId</em> property. Queries are more expensive, and may match multiple instances, which should be considered when designing state machines and events.</p> <blockquote><p>Whenever possible, try to correlation using the CorrelationId. If a query is required, it may be necessary to create an index on the property so that database queries are optimized.</p></blockquote> <p>To correlate events using another type, additional configuration is required.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ExternalOrderSubmitted</span>
<span class="token punctuation">{</span>    
    <span class="token return-type class-name"><span class="token keyword">string</span></span> OrderNumber <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Event</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> ExternalOrderSubmitted<span class="token punctuation">,</span> e <span class="token operator">=&gt;</span> e
            <span class="token punctuation">.</span><span class="token function">CorrelateBy</span><span class="token punctuation">(</span>i <span class="token operator">=&gt;</span> i<span class="token punctuation">.</span>OrderNumber<span class="token punctuation">,</span> x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderNumber<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">SelectId</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> NewId<span class="token punctuation">.</span><span class="token function">NextGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Event<span class="token punctuation">&lt;</span>ExternalOrderSubmitted<span class="token punctuation">&gt;</span></span> ExternalOrderSubmitted <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Queries can also be written with two arguments, which are passed directly to the repository (and must be supported by the backing database).</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ExternalOrderSubmitted</span>
<span class="token punctuation">{</span>    
    <span class="token return-type class-name"><span class="token keyword">string</span></span> OrderNumber <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Event</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> ExternalOrderSubmitted<span class="token punctuation">,</span> e <span class="token operator">=&gt;</span> e
            <span class="token punctuation">.</span><span class="token function">CorrelateBy</span><span class="token punctuation">(</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span>context<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> instance<span class="token punctuation">.</span>OrderNumber <span class="token operator">==</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderNumber<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">SelectId</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> NewId<span class="token punctuation">.</span><span class="token function">NextGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Event<span class="token punctuation">&lt;</span>ExternalOrderSubmitted<span class="token punctuation">&gt;</span></span> ExternalOrderSubmitted <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>When the event doesn't have a <em>Guid</em> that uniquely correlates to an instance, the <code>.SelectId</code> expression must be configured. In the above example, <a href="https://www.nuget.org/packages/NewId" target="_blank" rel="noopener noreferrer">NewId<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is used to generate a sequential identifier which will be assigned to the instance <em>CorrelationId</em>. Any property on the event can be used to initialize the <em>CorrelationId</em>.</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>Initial events that do not correlate on CorrelationId, and use <code>SelectId</code> to generate a <em>CorrelationId</em> should use a unique constraint on the instance property (<em>OrderNumber</em> in this example) to avoid duplicate instances. If two events correlate to the same property value at the same time, only one of the two will be able to store the instance, the other will fail (and, if retry is configured, which it should be when using a saga) and retry at which time the event will be dispatched based upon the current instance state (which is likely no longer Initial). Failure to apply a unique constraint (on <em>OrderNumber</em> in this example) will result in duplicates.</p></div> <p>The message headers are also available, for example, instead of always generating a new identifier, the <em>CorrelationId</em> header could be used if present.</p> <div class="language-cs extra-class"><pre class="language-cs"><code>            <span class="token punctuation">.</span><span class="token function">SelectId</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>CorrelationId <span class="token operator">??</span> NewId<span class="token punctuation">.</span><span class="token function">NextGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Event correlation is critical, and should be consistently applied to all events on a state machine. Consider how events received in different orders may affect subsequent event correlations.</p></div> <h3 id="ignore-event"><a href="#ignore-event" class="header-anchor">#</a> Ignore Event</h3> <p>It may be necessary to ignore an event in a given state, either to avoid fault generation, or to prevent messages from being moved to the <em>_skipped</em> queue. To ignore an event in a state, use the <code>Ignore</code> method.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Initially</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderAccepted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Accepted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">During</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderAccepted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Accepted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">During</span><span class="token punctuation">(</span>Accepted<span class="token punctuation">,</span>
            <span class="token function">Ignore</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="composite-event"><a href="#composite-event" class="header-anchor">#</a> Composite Event</h3> <p>A composite event is configured by specifying one or more events that must be consumed, after which the composite event will be raised. A composite event uses an instance property to keep track of the required events, which is specified during configuration.</p> <p>To define a composite event, the required events must first be configured along with any event behaviors, after which the composite event can be configured.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderState</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">SagaStateMachineInstance</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> CorrelationId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> CurrentState <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> ReadyEventStatus <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Initially</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderAccepted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Accepted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">During</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderAccepted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Accepted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">CompositeEvent</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> OrderReady<span class="token punctuation">,</span> x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>ReadyEventStatus<span class="token punctuation">,</span> SubmitOrder<span class="token punctuation">,</span> OrderAccepted<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">DuringAny</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderReady<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Then</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Order Ready: {0}&quot;</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>CorrelationId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Event</span> OrderReady <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Once the <em>SubmitOrder</em> and <em>OrderAccepted</em> events have been consumed, the <em>OrderReady</em> event will be triggered.</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>The order of events being declared can impact the order in which they execute. Therefore, it is best to declare composite events at the end of the state machine declaration, after all other events and behaviors are declared. That way, the composite events will be raised <em>after</em> the dependent event behaviors.</p></div> <h3 id="missing-instance"><a href="#missing-instance" class="header-anchor">#</a> Missing Instance</h3> <p>If an event is not matching to an instance, the missing instance behavior can be configured.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RequestOrderCancellation</span>
<span class="token punctuation">{</span>    
    <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderNotFound</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Event</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> OrderCancellationRequested<span class="token punctuation">,</span> e <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">CorrelateById</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId<span class="token punctuation">)</span><span class="token punctuation">;</span>

            e<span class="token punctuation">.</span><span class="token function">OnMissingInstance</span><span class="token punctuation">(</span>m <span class="token operator">=&gt;</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">return</span> m<span class="token punctuation">.</span><span class="token function">ExecuteAsync</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RespondAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderNotFound<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> x<span class="token punctuation">.</span>OrderId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Event<span class="token punctuation">&lt;</span>RequestOrderCancellation<span class="token punctuation">&gt;</span></span> OrderCancellationRequested <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>In this example, when a cancel order request is consumed without a matching instance, a response will be sent that the order was not found. Instead of generating a <code>Fault</code>, the response is more explicit. Other missing instance options include <code>Discard</code>, <code>Fault</code>, and <code>Execute</code> (a synchronous version of <em>ExecuteAsync</em>).</p> <h3 id="initial-insert"><a href="#initial-insert" class="header-anchor">#</a> Initial Insert</h3> <p>To increase new instance performance, configuring an event to directly insert into a saga repository may reduce lock contention. To configure an event to insert, it should be in the <em>Initially</em> block, as well as have a saga factory specified.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SubmitOrder</span>
<span class="token punctuation">{</span>    
    <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Event</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> SubmitOrder<span class="token punctuation">,</span> e <span class="token operator">=&gt;</span> 
        <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">CorrelateById</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            e<span class="token punctuation">.</span>InsertOnInitial <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">SetSagaFactory</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OrderState</span>
            <span class="token punctuation">{</span>
                CorrelationId <span class="token operator">=</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">Initially</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Event<span class="token punctuation">&lt;</span>SubmitOrder<span class="token punctuation">&gt;</span></span> SubmitOrder <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>When using <em>InsertOnInitial</em>, it is critical that the saga repository is able to detect duplicate keys (in this case, <em>CorrelationId</em> - which is initialized using <em>OrderId</em>). In this case, having a clustered primary key on <em>CorrelationId</em> would prevent duplicate instances from being inserted. If an event is correlated using a different property, make sure that the database enforces a unique constraint on the instance property and the saga factory initializes the instance property with the event property value.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ExternalOrderSubmitted</span>
<span class="token punctuation">{</span>    
    <span class="token return-type class-name"><span class="token keyword">string</span></span> OrderNumber <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Event</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> ExternalOrderSubmitted<span class="token punctuation">,</span> e <span class="token operator">=&gt;</span> 
        <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">CorrelateBy</span><span class="token punctuation">(</span>i <span class="token operator">=&gt;</span> i<span class="token punctuation">.</span>OrderNumber<span class="token punctuation">,</span> x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderNumber<span class="token punctuation">)</span>
            e<span class="token punctuation">.</span><span class="token function">SelectId</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> NewId<span class="token punctuation">.</span><span class="token function">NextGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            e<span class="token punctuation">.</span>InsertOnInitial <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">SetSagaFactory</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OrderState</span>
            <span class="token punctuation">{</span>
                CorrelationId <span class="token operator">=</span> context<span class="token punctuation">.</span>CorrelationId <span class="token operator">??</span> NewId<span class="token punctuation">.</span><span class="token function">NextGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                OrderNumber <span class="token operator">=</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderNumber<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">Initially</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Event<span class="token punctuation">&lt;</span>ExternalOrderSubmitted<span class="token punctuation">&gt;</span></span> ExternalOrderSubmitted <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The database would use a unique constraint on the <em>OrderNumber</em> to prevent duplicates, which the saga repository would detect as an existing instance, which would then be loaded to consume the event.</p> <h3 id="completed-instance"><a href="#completed-instance" class="header-anchor">#</a> Completed Instance</h3> <p>By default, instances are not removed from the saga repository. To configure completed instance removal, specify the method used to determine if an instance has completed.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderCompleted</span>
<span class="token punctuation">{</span>    
    <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Event</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> OrderCompleted<span class="token punctuation">,</span> x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token function">CorrelateById</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">DuringAny</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderCompleted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">SetCompletedWhenFinalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Event<span class="token punctuation">&lt;</span>OrderCompleted<span class="token punctuation">&gt;</span></span> OrderCompleted <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>When the instance consumes the <em>OrderCompleted</em> event, the instance is finalized (which transitions the instance to the <em>Final</em> state). The <code>SetCompletedWhenFinalized</code> method defines an instance in the <em>Final</em> state as completed – which is then used by the saga repository to remove the instance.</p> <p>To use a different completed expression, such as one that checks if the instance is in a <em>Completed</em> state, use the <code>SetCompleted</code> method as shown below.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderCompleted</span>
<span class="token punctuation">{</span>    
    <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Event</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> OrderCompleted<span class="token punctuation">,</span> x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token function">CorrelateById</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">DuringAny</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderCompleted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Completed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">SetCompleted</span><span class="token punctuation">(</span><span class="token keyword">async</span> instance <span class="token operator">=&gt;</span> 
        <span class="token punctuation">{</span>
            <span class="token class-name">State<span class="token punctuation">&lt;</span>TInstance<span class="token punctuation">&gt;</span></span> currentState <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">GetState</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> Completed<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>currentState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">State</span> Completed <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Event<span class="token punctuation">&lt;</span>OrderCompleted<span class="token punctuation">&gt;</span></span> OrderCompleted <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="activities"><a href="#activities" class="header-anchor">#</a> Activities</h2> <p>State machine behaviors are defined as a sequence of activities which are executed in response to an event. In addition to the activities included with Automatonymous, MassTransit includes activities to send, publish, and schedule messages, as well as initiate and respond to requests.</p> <h3 id="publish"><a href="#publish" class="header-anchor">#</a> Publish</h3> <p>To publish an event, add a <code>Publish</code> activity.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderSubmitted</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderSubmittedEvent</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">OrderSubmitted</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderSubmittedEvent</span><span class="token punctuation">(</span><span class="token class-name">Guid</span> orderId<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        OrderId <span class="token operator">=</span> orderId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Initially</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Publish</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>OrderSubmitted<span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">OrderSubmittedEvent</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>CorrelationId<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Alternatively, a message initializer can be used to eliminate the <em>Event</em> class.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderSubmitted</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Initially</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">PublishAsync</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Init</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderSubmitted<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>CorrelationId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="send"><a href="#send" class="header-anchor">#</a> Send</h3> <p>To send a message, add a <code>Send</code> activity.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UpdateAccountHistory</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UpdateAccountHistoryCommand</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">UpdateAccountHistory</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">UpdateAccountHistoryCommand</span><span class="token punctuation">(</span><span class="token class-name">Guid</span> orderId<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        OrderId <span class="token operator">=</span> orderId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token class-name">OrderStateMachineSettings</span> settings<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Initially</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>settings<span class="token punctuation">.</span>AccountServiceAddress<span class="token punctuation">,</span> context <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">UpdateAccountHistoryCommand</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>CorrelationId<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Alternatively, a message initializer can be used to eliminate the <em>Command</em> class.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UpdateAccountHistory</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token class-name">OrderStateMachineSettings</span> settings<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Initially</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">SendAsync</span><span class="token punctuation">(</span>settings<span class="token punctuation">.</span>AccountServiceAddress<span class="token punctuation">,</span> context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Init</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>UpdateAccountHistory<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>CorrelationId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="respond"><a href="#respond" class="header-anchor">#</a> Respond</h3> <p>A state machine can respond to requests by configuring the request message type as an event, and using the <code>Respond</code> method. When configuring a request event, configuring a missing instance method is recommended, to provide a better response experience (either through a different response type, or a response that indicates an instance was not found).</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RequestOrderCancellation</span>
<span class="token punctuation">{</span>    
    <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderCanceled</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderNotFound</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Event</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> OrderCancellationRequested<span class="token punctuation">,</span> e <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">CorrelateById</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId<span class="token punctuation">)</span><span class="token punctuation">;</span>

            e<span class="token punctuation">.</span><span class="token function">OnMissingInstance</span><span class="token punctuation">(</span>m <span class="token operator">=&gt;</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">return</span> m<span class="token punctuation">.</span><span class="token function">ExecuteAsync</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RespondAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderNotFound<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> x<span class="token punctuation">.</span>OrderId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">DuringAny</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderCancellationRequested<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">RespondAsync</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Init</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderCanceled<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>CorrelationId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Canceled<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">State</span> Canceled <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Event<span class="token punctuation">&lt;</span>RequestOrderCancellation<span class="token punctuation">&gt;</span></span> OrderCancellationRequested <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>There are scenarios where it is required to <em>wait</em> for the response from the state machine. In these scenarios the information that is required to respond to the original request should be stored.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">record</span> <span class="token class-name">CreateOrder</span><span class="token punctuation">(</span><span class="token class-name">Guid</span> CorrelationId<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">CorrelatedBy<span class="token punctuation">&lt;</span>Guid<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">record</span> <span class="token class-name">ProcessOrder</span><span class="token punctuation">(</span><span class="token class-name">Guid</span> OrderId<span class="token punctuation">,</span> <span class="token class-name">Guid</span> ProcessingId<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">record</span> <span class="token class-name">OrderProcessed</span><span class="token punctuation">(</span><span class="token class-name">Guid</span> OrderId<span class="token punctuation">,</span> <span class="token class-name">Guid</span> ProcessingId<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">record</span> <span class="token class-name">OrderCancelled</span><span class="token punctuation">(</span><span class="token class-name">Guid</span> OrderId<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> Reason<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProcessOrderConsumer</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IConsumer<span class="token punctuation">&lt;</span>ProcessOrder<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Consume</span><span class="token punctuation">(</span><span class="token class-name">ConsumeContext<span class="token punctuation">&lt;</span>ProcessOrder<span class="token punctuation">&gt;</span></span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token function">RespondAsync</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">OrderProcessed</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId<span class="token punctuation">,</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>ProcessingId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderState</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">SagaStateMachineInstance</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> CorrelationId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> CurrentState <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid<span class="token punctuation">?</span></span> ProcessingId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid<span class="token punctuation">?</span></span> RequestId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Uri</span> ResponseAddress <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">State</span> Created <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token return-type class-name">State</span> Cancelled <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token return-type class-name">Event<span class="token punctuation">&lt;</span>CreateOrder<span class="token punctuation">&gt;</span></span> OrderSubmitted <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token return-type class-name">Request<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">,</span> ProcessOrder<span class="token punctuation">,</span> OrderProcessed<span class="token punctuation">&gt;</span></span> ProcessOrder <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">InstanceState</span><span class="token punctuation">(</span>m <span class="token operator">=&gt;</span> m<span class="token punctuation">.</span>CurrentState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">Event</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> OrderSubmitted<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> ProcessOrder<span class="token punctuation">,</span> order <span class="token operator">=&gt;</span> order<span class="token punctuation">.</span>ProcessingId<span class="token punctuation">,</span> config <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> config<span class="token punctuation">.</span>Timeout <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span>Zero<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">Initially</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderSubmitted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Then</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span>
                <span class="token punctuation">{</span>
                    context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>CorrelationId <span class="token operator">=</span> context<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>CorrelationId<span class="token punctuation">;</span>
                    context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>ProcessingId <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>OrderId <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span><span class="token function">TryGetPayload</span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name">SagaConsumeContext<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">,</span> CreateOrder<span class="token punctuation">&gt;</span></span> payload<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to retrieve required payload for callback data.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>RequestId <span class="token operator">=</span> payload<span class="token punctuation">.</span>RequestId<span class="token punctuation">;</span>
                    context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>ResponseAddress <span class="token operator">=</span> payload<span class="token punctuation">.</span>ResponseAddress<span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Request</span><span class="token punctuation">(</span>ProcessOrder<span class="token punctuation">,</span> context <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ProcessOrder</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>OrderId<span class="token punctuation">,</span> context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>ProcessingId<span class="token operator">!</span><span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>ProcessOrder<span class="token punctuation">.</span>Pending<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token function">During</span><span class="token punctuation">(</span>ProcessOrder<span class="token punctuation">.</span>Pending<span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>ProcessOrder<span class="token punctuation">.</span>Completed<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Created<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">ThenAsync</span><span class="token punctuation">(</span><span class="token keyword">async</span> context <span class="token operator">=&gt;</span>
                <span class="token punctuation">{</span>
                    <span class="token class-name"><span class="token keyword">var</span></span> endpoint <span class="token operator">=</span> <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token function">GetSendEndpoint</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>ResponseAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">await</span> endpoint<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Instance<span class="token punctuation">,</span> r <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span>RequestId <span class="token operator">=</span> context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>RequestId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>ProcessOrder<span class="token punctuation">.</span>Faulted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Cancelled<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">ThenAsync</span><span class="token punctuation">(</span><span class="token keyword">async</span> context <span class="token operator">=&gt;</span>
                <span class="token punctuation">{</span>
                    <span class="token class-name"><span class="token keyword">var</span></span> endpoint <span class="token operator">=</span> <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token function">GetSendEndpoint</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>ResponseAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">await</span> endpoint<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">OrderCancelled</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>OrderId<span class="token punctuation">,</span> <span class="token string">&quot;Faulted&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span>RequestId <span class="token operator">=</span> context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>RequestId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>ProcessOrder<span class="token punctuation">.</span>TimeoutExpired<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Cancelled<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">ThenAsync</span><span class="token punctuation">(</span><span class="token keyword">async</span> context <span class="token operator">=&gt;</span>
                <span class="token punctuation">{</span>
                    <span class="token class-name"><span class="token keyword">var</span></span> endpoint <span class="token operator">=</span> <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token function">GetSendEndpoint</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>ResponseAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">await</span> endpoint<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">OrderCancelled</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>OrderId<span class="token punctuation">,</span> <span class="token string">&quot;Time-out&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span>RequestId <span class="token operator">=</span> context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>RequestId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="schedule"><a href="#schedule" class="header-anchor">#</a> Schedule</h3> <div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>The bus must be configured to include a message scheduler to use the scheduling activities. See the <a href="/advanced/scheduling/">scheduling</a> section to learn how to setup a message scheduler.</p></div> <p>A state machine can schedule events, which uses the message scheduler to schedule a message for delivery to the instance. First, the schedule must be declared.</p> <div class="language-cs extra-class"><div class="highlight-lines"><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><div class="highlighted"> </div><br><br></div><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderCompletionTimeoutExpired</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderState</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">SagaStateMachineInstance</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> CorrelationId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> CurrentState <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Guid<span class="token punctuation">?</span></span> OrderCompletionTimeoutTokenId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Schedule</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> OrderCompletionTimeout<span class="token punctuation">,</span> instance <span class="token operator">=&gt;</span> instance<span class="token punctuation">.</span>OrderCompletionTimeoutTokenId<span class="token punctuation">,</span> s <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
            s<span class="token punctuation">.</span>Delay <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromDays</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            s<span class="token punctuation">.</span>Received <span class="token operator">=</span> r <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">CorrelateById</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Schedule<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">,</span> OrderCompletionTimeoutExpired<span class="token punctuation">&gt;</span></span> OrderCompletionTimeout <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The configuration specifies the <em>Delay</em>, which can be overridden by the schedule activity, and the correlation expression for the <em>Received</em> event. The state machine can consume the <em>Received</em> event as shown. The <em>OrderCompletionTimeoutTokenId</em> is a <code>Guid?</code> instance property used to keep track of the scheduled message <em>tokenId</em> which can later be used to unschedule the event.</p> <div class="language-cs extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderCompleted</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">During</span><span class="token punctuation">(</span>Accepted<span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderCompletionTimeout<span class="token punctuation">.</span>Received<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">PublishAsync</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Init</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderCompleted<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>CorrelationId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Schedule<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">,</span> OrderCompletionTimeoutExpired<span class="token punctuation">&gt;</span></span> OrderCompletionTimeout <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The event can be scheduled using the <code>Schedule</code> activity.</p> <div class="language-cs extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br></div><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">During</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderAccepted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Schedule</span><span class="token punctuation">(</span>OrderCompletionTimeout<span class="token punctuation">,</span> context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Init</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderCompletionTimeoutExpired<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>CorrelationId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Accepted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>As stated above, the <em>delay</em> can be overridden by the <em>Schedule</em> activity. Both instance and message (<em>context.Data</em>) content can be used to calculate the delay.</p> <div class="language-cs extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br></div><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderAccepted</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    
    <span class="token return-type class-name">TimeSpan</span> CompletionTime <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">During</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderAccepted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Schedule</span><span class="token punctuation">(</span>OrderCompletionTimeout<span class="token punctuation">,</span> context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Init</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderCompletionTimeoutExpired<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>CorrelationId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>CompletionTime<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Accepted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Once the scheduled event is received, the <code>OrderCompletionTimeoutTokenId</code> property is cleared.</p> <p>If the scheduled event is no longer needed, the <em>Unschedule</em> activity can be used.</p> <div class="language-cs extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br></div><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderAccepted</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    
    <span class="token return-type class-name">TimeSpan</span> CompletionTime <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">DuringAny</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderCancellationRequested<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">RespondAsync</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Init</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderCanceled<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>CorrelationId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Unschedule</span><span class="token punctuation">(</span>OrderCompletionTimeout<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Canceled<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="request"><a href="#request" class="header-anchor">#</a> Request</h3> <p>A request can be sent by a state machine using the <em>Request</em> method, which specifies the request type and the response type. Additional request settings may be specified, including the <em>ServiceAddress</em> and the <em>Timeout</em>.</p> <p>If the <em>ServiceAddress</em> is specified, it should be the endpoint address of the service that will respond to the request. If not specified, the request will be published.</p> <p>The default <em>Timeout</em> is thirty seconds but any value greater than or equal to <code>TimeSpan.Zero</code> can be specified. When a request is sent with a timeout greater than zero, a <em>TimeoutExpired</em> message is scheduled. Specifying <code>TimeSpan.Zero</code> will not schedule a timeout message and the request will never time out.</p> <div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>When a <em>Timeout</em> greater than <code>Timespan.Zero</code> is configured, a message scheduler must be configured. See the <a href="/advanced/scheduling/">scheduling</a> section for details on configuring a message scheduler.</p></div> <p>When defining a <code>Request</code>, an instance property <em>should</em> be specified to store the <em>RequestId</em> which is used to correlate responses to the state machine instance. While the request is pending, the <em>RequestId</em> is stored in the property. When the request has completed the property is cleared. If the request times out or faults, the <em>RequestId</em> is retained to allow for later correlation if requests are ultimately completed (such as moving requests from the <em>_error</em> queue back into the service queue).</p> <p>A recent enhancement making this property optional, instead using the instance's <code>CorrelationId</code> for the request message <code>RequestId</code>. This can simplify response correlation, and also avoids the need of a supplemental index on the saga repository. However, reusing the <code>CorrelationId</code> for the request might cause issues in highly complex systems. So consider this when choosing which method to use.</p> <h4 id="configuration-2"><a href="#configuration-2" class="header-anchor">#</a> Configuration</h4> <p>To declare a request, add a <code>Request</code> property and configure it using the <code>Request</code> method.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ProcessOrder</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderProcessed</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name">Guid</span> ProcessingId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderState</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">SagaStateMachineInstance</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> CorrelationId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> CurrentState <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Guid<span class="token punctuation">?</span></span> ProcessOrderRequestId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid<span class="token punctuation">?</span></span> ProcessingId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token class-name">OrderStateMachineSettings</span> settings<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Request</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> ProcessOrder<span class="token punctuation">,</span>
            x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>ProcessOrderRequestId<span class="token punctuation">,</span> <span class="token comment">// Optional</span>
            r <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                r<span class="token punctuation">.</span>ServiceAddress <span class="token operator">=</span> settings<span class="token punctuation">.</span>ProcessOrderServiceAddress<span class="token punctuation">;</span>
                r<span class="token punctuation">.</span>Timeout <span class="token operator">=</span> settings<span class="token punctuation">.</span>RequestTimeout<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Request<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">,</span> ProcessOrder<span class="token punctuation">,</span> OrderProcessed<span class="token punctuation">&gt;</span></span> ProcessOrder <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Once defined, the request activity can be added to a behavior.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">During</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderAccepted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Request</span><span class="token punctuation">(</span>ProcessOrder<span class="token punctuation">,</span> x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Init</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ProcessOrder<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> x<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>CorrelationId<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>ProcessOrder<span class="token punctuation">.</span>Pending<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">During</span><span class="token punctuation">(</span>ProcessOrder<span class="token punctuation">.</span>Pending<span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>ProcessOrder<span class="token punctuation">.</span>Completed<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Then</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>ProcessingId <span class="token operator">=</span> context<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>ProcessingId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Processed<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>ProcessOrder<span class="token punctuation">.</span>Faulted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>ProcessFaulted<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>ProcessOrder<span class="token punctuation">.</span>TimeoutExpired<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>ProcessTimeoutExpired<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">State</span> Processed <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">State</span> ProcessFaulted <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">State</span> ProcessTimeoutExpired <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The <em>Request</em> includes three events: _Completed, <em>Faulted</em>, and <em>TimeoutExpired</em>. These events can be consumed during any state, however, the <em>Request</em> includes a <em>Pending</em> state which can be used to avoid declaring a separate pending state.</p> <div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>The request timeout is scheduled using the message scheduler, and the scheduled message is canceled when a response or fault is received. Not all message schedulers support cancellation, so it may be necessary to <em>Ignore</em> the <code>TimeoutExpired</code> event in subsequent states.</p></div> <h3 id="custom"><a href="#custom" class="header-anchor">#</a> Custom</h3> <p>There are scenarios when an event behavior may have dependencies that need to be managed at a scope level, such as a database connection, or the complexity is best encapsulated in a separate class rather than being part of the state machine itself. Developers can create their own activities for state machine use, and optionally create their own extension methods to add them to a behavior.</p> <p>To create an activity, create a class that implements <code>IActivity&lt;TInstance, TData&gt;</code> as shown.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PublishOrderSubmittedActivity</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">Activity<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">,</span> SubmitOrder<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">readonly</span> <span class="token class-name">ConsumeContext</span> _context<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">PublishOrderSubmittedActivity</span><span class="token punctuation">(</span><span class="token class-name">ConsumeContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _context <span class="token operator">=</span> context<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Probe</span><span class="token punctuation">(</span><span class="token class-name">ProbeContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        context<span class="token punctuation">.</span><span class="token function">CreateScope</span><span class="token punctuation">(</span><span class="token string">&quot;publish-order-submitted&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Accept</span><span class="token punctuation">(</span><span class="token class-name">StateMachineVisitor</span> visitor<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        visitor<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token class-name">BehaviorContext<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">,</span> SubmitOrder<span class="token punctuation">&gt;</span></span> context<span class="token punctuation">,</span> <span class="token class-name">Behavior<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">,</span> SubmitOrder<span class="token punctuation">&gt;</span></span> next<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// do the activity thing</span>
        <span class="token keyword">await</span> _context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Publish</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderSubmitted<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>CorrelationId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConfigureAwait</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// call the next activity in the behavior</span>
        <span class="token keyword">await</span> next<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConfigureAwait</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Task</span> <span class="token generic-method"><span class="token function">Faulted</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TException<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">BehaviorExceptionContext<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">,</span> SubmitOrder<span class="token punctuation">,</span> TException<span class="token punctuation">&gt;</span></span> context<span class="token punctuation">,</span> <span class="token class-name">Behavior<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">,</span> SubmitOrder<span class="token punctuation">&gt;</span></span> next<span class="token punctuation">)</span>
        <span class="token keyword">where</span> <span class="token class-name">TException</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Exception</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> next<span class="token punctuation">.</span><span class="token function">Faulted</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Once created, configure the activity in a state machine as shown.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderSubmitted</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Initially</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Activity</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">OfType</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>PublishOrderSubmittedActivity<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>When the <code>SubmitOrder</code> event is consumed, the state machine will resolve the activity from the container, and call the <code>Execute</code> method. The activity will be scoped, so any dependencies will be resolved within the message <code>ConsumeContext</code>.</p> <p>In the above example, the event type was known in advance. If an activity for any event type is needed, it can be created without specifying the event type.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PublishOrderSubmittedActivity</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">Activity<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">readonly</span> <span class="token class-name">ConsumeContext</span> _context<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">PublishOrderSubmittedActivity</span><span class="token punctuation">(</span><span class="token class-name">ConsumeContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _context <span class="token operator">=</span> context<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Probe</span><span class="token punctuation">(</span><span class="token class-name">ProbeContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        context<span class="token punctuation">.</span><span class="token function">CreateScope</span><span class="token punctuation">(</span><span class="token string">&quot;publish-order-submitted&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Accept</span><span class="token punctuation">(</span><span class="token class-name">StateMachineVisitor</span> visitor<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        visitor<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token class-name">BehaviorContext<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span> context<span class="token punctuation">,</span> <span class="token class-name">Behavior<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span> next<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> _context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Publish</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderSubmitted<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>CorrelationId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConfigureAwait</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> next<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConfigureAwait</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token generic-method"><span class="token function">Execute</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">BehaviorContext<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">,</span> T<span class="token punctuation">&gt;</span></span> context<span class="token punctuation">,</span> <span class="token class-name">Behavior<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">,</span> T<span class="token punctuation">&gt;</span></span> next<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> _context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Publish</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderSubmitted<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>CorrelationId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConfigureAwait</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> next<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConfigureAwait</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Task</span> <span class="token generic-method"><span class="token function">Faulted</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TException<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">BehaviorExceptionContext<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">,</span> TException<span class="token punctuation">&gt;</span></span> context<span class="token punctuation">,</span> <span class="token class-name">Behavior<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span> next<span class="token punctuation">)</span> 
        <span class="token keyword">where</span> <span class="token class-name">TException</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Exception</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> next<span class="token punctuation">.</span><span class="token function">Faulted</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Task</span> <span class="token generic-method"><span class="token function">Faulted</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> TException<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">BehaviorExceptionContext<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">,</span> T<span class="token punctuation">,</span> TException<span class="token punctuation">&gt;</span></span> context<span class="token punctuation">,</span> <span class="token class-name">Behavior<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">,</span> T<span class="token punctuation">&gt;</span></span> next<span class="token punctuation">)</span>
        <span class="token keyword">where</span> <span class="token class-name">TException</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Exception</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> next<span class="token punctuation">.</span><span class="token function">Faulted</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>To register an instance activity, use the following syntax.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderSubmitted</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">MassTransitStateMachine<span class="token punctuation">&lt;</span>OrderState<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Initially</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Activity</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">OfInstanceType</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>PublishOrderSubmittedActivity<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/MassTransit/MassTransit/edit/develop/docs/usage/sagas/automatonymous.md" target="_blank" rel="noopener noreferrer">Help us by improving this page!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/24/2022, 7:10:01 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/usage/requests.html" class="prev">
        Requests
      </a></span> <span class="next"><a href="/usage/sagas/consumer-saga.html">
        Consumer Sagas
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.0f717998.js" defer></script><script src="/assets/js/3.da322882.js" defer></script><script src="/assets/js/136.c0914ec3.js" defer></script>
  </body>
</html>
