<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Mediator | MassTransit</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#3a0839">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="description" content="A free, open-source distributed application framework for .NET.">
    <meta name="msapplication-TileColor" content="#3a0839">
    <meta name="msapplication-config" content="/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    
    <link rel="preload" href="/assets/css/0.styles.af8ca635.css" as="style"><link rel="preload" href="/assets/js/app.0f717998.js" as="script"><link rel="preload" href="/assets/js/3.da322882.js" as="script"><link rel="preload" href="/assets/js/126.6c0ed471.js" as="script"><link rel="prefetch" href="/assets/js/10.941c3d0b.js"><link rel="prefetch" href="/assets/js/100.23f1c4ea.js"><link rel="prefetch" href="/assets/js/101.710aa7a5.js"><link rel="prefetch" href="/assets/js/102.827dba0e.js"><link rel="prefetch" href="/assets/js/103.fdd173f3.js"><link rel="prefetch" href="/assets/js/104.8c1a005f.js"><link rel="prefetch" href="/assets/js/105.95990127.js"><link rel="prefetch" href="/assets/js/106.c4b2015b.js"><link rel="prefetch" href="/assets/js/107.e0acc6f2.js"><link rel="prefetch" href="/assets/js/108.78eab687.js"><link rel="prefetch" href="/assets/js/109.b4d1a487.js"><link rel="prefetch" href="/assets/js/11.76406285.js"><link rel="prefetch" href="/assets/js/110.f0a83b63.js"><link rel="prefetch" href="/assets/js/111.3f22952e.js"><link rel="prefetch" href="/assets/js/112.1ad12ad5.js"><link rel="prefetch" href="/assets/js/113.40368044.js"><link rel="prefetch" href="/assets/js/114.3cd980b4.js"><link rel="prefetch" href="/assets/js/115.00f2166d.js"><link rel="prefetch" href="/assets/js/116.6670b5f2.js"><link rel="prefetch" href="/assets/js/117.4a42c861.js"><link rel="prefetch" href="/assets/js/118.e6410316.js"><link rel="prefetch" href="/assets/js/119.dd058ee6.js"><link rel="prefetch" href="/assets/js/12.4464da33.js"><link rel="prefetch" href="/assets/js/120.cccb363a.js"><link rel="prefetch" href="/assets/js/121.75e3ed75.js"><link rel="prefetch" href="/assets/js/122.ddb3d7e5.js"><link rel="prefetch" href="/assets/js/123.f7ca23b1.js"><link rel="prefetch" href="/assets/js/124.2e501680.js"><link rel="prefetch" href="/assets/js/125.4d5eeb88.js"><link rel="prefetch" href="/assets/js/127.6d232467.js"><link rel="prefetch" href="/assets/js/128.7a780f23.js"><link rel="prefetch" href="/assets/js/129.7fda41f1.js"><link rel="prefetch" href="/assets/js/13.512e3537.js"><link rel="prefetch" href="/assets/js/130.19738da2.js"><link rel="prefetch" href="/assets/js/131.6e3916b7.js"><link rel="prefetch" href="/assets/js/132.bdf944d1.js"><link rel="prefetch" href="/assets/js/133.bf0cdaf4.js"><link rel="prefetch" href="/assets/js/134.a24e70f8.js"><link rel="prefetch" href="/assets/js/135.3087f6fe.js"><link rel="prefetch" href="/assets/js/136.c0914ec3.js"><link rel="prefetch" href="/assets/js/137.adc2c79a.js"><link rel="prefetch" href="/assets/js/138.6300f157.js"><link rel="prefetch" href="/assets/js/139.b2f14afc.js"><link rel="prefetch" href="/assets/js/14.f3f541c4.js"><link rel="prefetch" href="/assets/js/140.66174436.js"><link rel="prefetch" href="/assets/js/141.548ac70e.js"><link rel="prefetch" href="/assets/js/142.31e46e2f.js"><link rel="prefetch" href="/assets/js/143.e450e37e.js"><link rel="prefetch" href="/assets/js/144.1a7bdf49.js"><link rel="prefetch" href="/assets/js/145.8bd22f33.js"><link rel="prefetch" href="/assets/js/146.e9cae417.js"><link rel="prefetch" href="/assets/js/147.99c43782.js"><link rel="prefetch" href="/assets/js/148.0001e2e5.js"><link rel="prefetch" href="/assets/js/149.8dd98593.js"><link rel="prefetch" href="/assets/js/15.5b1e58a2.js"><link rel="prefetch" href="/assets/js/150.576d606c.js"><link rel="prefetch" href="/assets/js/151.7ffc60f8.js"><link rel="prefetch" href="/assets/js/152.64603d5f.js"><link rel="prefetch" href="/assets/js/153.04273ceb.js"><link rel="prefetch" href="/assets/js/154.5ecb1789.js"><link rel="prefetch" href="/assets/js/155.2443a17f.js"><link rel="prefetch" href="/assets/js/156.89bc3ef2.js"><link rel="prefetch" href="/assets/js/157.d2092780.js"><link rel="prefetch" href="/assets/js/158.abc54fe2.js"><link rel="prefetch" href="/assets/js/159.f591dba4.js"><link rel="prefetch" href="/assets/js/16.b89c7882.js"><link rel="prefetch" href="/assets/js/17.8a846d9a.js"><link rel="prefetch" href="/assets/js/18.bd1ec876.js"><link rel="prefetch" href="/assets/js/19.00d1434f.js"><link rel="prefetch" href="/assets/js/20.384b5b5b.js"><link rel="prefetch" href="/assets/js/21.b1ed6e3f.js"><link rel="prefetch" href="/assets/js/22.f8fa29a7.js"><link rel="prefetch" href="/assets/js/23.d5d8e28e.js"><link rel="prefetch" href="/assets/js/24.0e4be943.js"><link rel="prefetch" href="/assets/js/25.d7ae1021.js"><link rel="prefetch" href="/assets/js/26.d7c52843.js"><link rel="prefetch" href="/assets/js/27.b8504be5.js"><link rel="prefetch" href="/assets/js/28.318c6322.js"><link rel="prefetch" href="/assets/js/29.eb49e807.js"><link rel="prefetch" href="/assets/js/30.9ff31a8a.js"><link rel="prefetch" href="/assets/js/31.f9836bae.js"><link rel="prefetch" href="/assets/js/32.4306b1f2.js"><link rel="prefetch" href="/assets/js/33.3cbf102a.js"><link rel="prefetch" href="/assets/js/34.82ea42b8.js"><link rel="prefetch" href="/assets/js/35.a4cf4586.js"><link rel="prefetch" href="/assets/js/36.c79bc776.js"><link rel="prefetch" href="/assets/js/37.93848c0f.js"><link rel="prefetch" href="/assets/js/38.aed8b2f5.js"><link rel="prefetch" href="/assets/js/39.0bd57e5e.js"><link rel="prefetch" href="/assets/js/4.37ee6b06.js"><link rel="prefetch" href="/assets/js/40.8a1415b1.js"><link rel="prefetch" href="/assets/js/41.d49c2efb.js"><link rel="prefetch" href="/assets/js/42.b7bbbaf6.js"><link rel="prefetch" href="/assets/js/43.87609deb.js"><link rel="prefetch" href="/assets/js/44.cee9abc3.js"><link rel="prefetch" href="/assets/js/45.55c4b4b6.js"><link rel="prefetch" href="/assets/js/46.fc3df9fc.js"><link rel="prefetch" href="/assets/js/47.126380a2.js"><link rel="prefetch" href="/assets/js/48.345456c9.js"><link rel="prefetch" href="/assets/js/49.cb212764.js"><link rel="prefetch" href="/assets/js/5.9fe86136.js"><link rel="prefetch" href="/assets/js/50.e2a625b8.js"><link rel="prefetch" href="/assets/js/51.a2301d85.js"><link rel="prefetch" href="/assets/js/52.7626f76b.js"><link rel="prefetch" href="/assets/js/53.6dcfb078.js"><link rel="prefetch" href="/assets/js/54.7d5b7906.js"><link rel="prefetch" href="/assets/js/55.2f161720.js"><link rel="prefetch" href="/assets/js/56.3baf6838.js"><link rel="prefetch" href="/assets/js/57.5952a2e8.js"><link rel="prefetch" href="/assets/js/58.35bd50d1.js"><link rel="prefetch" href="/assets/js/59.1a61c98b.js"><link rel="prefetch" href="/assets/js/6.ae895e4f.js"><link rel="prefetch" href="/assets/js/60.dde8f8f2.js"><link rel="prefetch" href="/assets/js/61.fc9b4fc0.js"><link rel="prefetch" href="/assets/js/62.a5b28645.js"><link rel="prefetch" href="/assets/js/63.16221e1a.js"><link rel="prefetch" href="/assets/js/64.573d11a6.js"><link rel="prefetch" href="/assets/js/65.0082a727.js"><link rel="prefetch" href="/assets/js/66.366ffe6e.js"><link rel="prefetch" href="/assets/js/67.2271d873.js"><link rel="prefetch" href="/assets/js/68.6cfc25bd.js"><link rel="prefetch" href="/assets/js/69.f91f0dae.js"><link rel="prefetch" href="/assets/js/7.77650bb5.js"><link rel="prefetch" href="/assets/js/70.9f842d94.js"><link rel="prefetch" href="/assets/js/71.f12cfc74.js"><link rel="prefetch" href="/assets/js/72.7c699f2b.js"><link rel="prefetch" href="/assets/js/73.2080b9dd.js"><link rel="prefetch" href="/assets/js/74.03ec3239.js"><link rel="prefetch" href="/assets/js/75.a2e95397.js"><link rel="prefetch" href="/assets/js/76.a8f91599.js"><link rel="prefetch" href="/assets/js/77.bb549269.js"><link rel="prefetch" href="/assets/js/78.56c8d184.js"><link rel="prefetch" href="/assets/js/79.99f38c6f.js"><link rel="prefetch" href="/assets/js/8.be925209.js"><link rel="prefetch" href="/assets/js/80.13f11752.js"><link rel="prefetch" href="/assets/js/81.028a7b5e.js"><link rel="prefetch" href="/assets/js/82.4956e61b.js"><link rel="prefetch" href="/assets/js/83.4efd0d82.js"><link rel="prefetch" href="/assets/js/84.e214e198.js"><link rel="prefetch" href="/assets/js/85.c935478c.js"><link rel="prefetch" href="/assets/js/86.bd6a9d11.js"><link rel="prefetch" href="/assets/js/87.47bd24e2.js"><link rel="prefetch" href="/assets/js/88.350bbf5d.js"><link rel="prefetch" href="/assets/js/89.32d2e3c2.js"><link rel="prefetch" href="/assets/js/9.b8c411bf.js"><link rel="prefetch" href="/assets/js/90.e0e9e669.js"><link rel="prefetch" href="/assets/js/91.a2c133e3.js"><link rel="prefetch" href="/assets/js/92.00ca9d52.js"><link rel="prefetch" href="/assets/js/93.70dcdd49.js"><link rel="prefetch" href="/assets/js/94.861c48fb.js"><link rel="prefetch" href="/assets/js/95.352fd642.js"><link rel="prefetch" href="/assets/js/96.e303cfc4.js"><link rel="prefetch" href="/assets/js/97.b5c87e83.js"><link rel="prefetch" href="/assets/js/98.1d3e5253.js"><link rel="prefetch" href="/assets/js/99.a0f7babd.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.ceb48f17.js">
    <link rel="stylesheet" href="/assets/css/0.styles.af8ca635.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/mt-logo-small.png" alt="MassTransit" class="logo"> <span class="site-name can-hide">MassTransit</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/discord.html" class="nav-link">
  Discord
</a></div><div class="nav-item"><a href="https://nuget.org/packages/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NuGet
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/discord.html" class="nav-link">
  Discord
</a></div><div class="nav-item"><a href="https://nuget.org/packages/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NuGet
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/getting-started/" class="sidebar-heading clickable"><span>Getting Started</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/getting-started/upgrade-v6.html" class="sidebar-link">Upgrading</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/releases/" class="sidebar-heading clickable"><span>Release Notes</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/usage/" class="sidebar-heading clickable router-link-active open"><span>Using MassTransit</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/usage/configuration.html" class="sidebar-link">Configuration</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/transports/" class="sidebar-heading clickable"><span>Transports</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/riders/" class="sidebar-heading clickable"><span>Riders</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/faas/" class="sidebar-heading clickable"><span>FaaS</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/usage/mediator.html" aria-current="page" class="active sidebar-link">Mediator</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/usage/messages.html" class="sidebar-link">Messages</a></li><li><a href="/usage/consumers.html" class="sidebar-link">Consumers</a></li><li><a href="/usage/producers.html" class="sidebar-link">Producers</a></li><li><a href="/usage/exceptions.html" class="sidebar-link">Exceptions</a></li><li><a href="/usage/requests.html" class="sidebar-link">Requests</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/sagas/" class="sidebar-heading clickable"><span>Sagas</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/containers/" class="sidebar-heading clickable"><span>Containers</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/usage/testing.html" class="sidebar-link">Testing</a></li><li><a href="/usage/logging.html" class="sidebar-link">Logging</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Advanced</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/learn/" class="sidebar-heading clickable"><span>Getting Help</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Articles</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/platform/" class="sidebar-heading clickable"><span>Platform</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Reference</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mediator"><a href="#mediator" class="header-anchor">#</a> Mediator</h1> <p>MassTransit includes a mediator implementation, with full support for consumers, handlers, and sagas (including saga state machines). MassTransit Mediator runs in-process and in-memory, no transport is required. For maximum performance, messages are passed by reference, instead than being serialized, and control flows directly from the <em>Publish</em>/<em>Send</em> caller to the consumer. If a consumer throws an exception, the <em>Publish</em>/<em>Send</em> method throws and the exception should be handled by the caller.</p> <div class="custom-block tip"><p class="custom-block-title">Mediator</p> <p>Mediator is a <a href="https://en.wikipedia.org/wiki/Mediator_pattern" target="_blank" rel="noopener noreferrer">behavioral design pattern<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> in which a <em>mediator</em> encapsulates communication between objects to reduce coupling.</p></div> <h3 id="configuration"><a href="#configuration" class="header-anchor">#</a> Configuration</h3> <p>To configure Mediator, use the <em>AddMediator</em> method.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">namespace</span> <span class="token namespace">UsageMediatorContainer</span>
<span class="token punctuation">{</span>
    <span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">UsageContracts</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">UsageConsumer</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">UsageMediatorConsumer</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">MassTransit</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">MassTransit<span class="token punctuation">.</span>Mediator</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>DependencyInjection</span><span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> services <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServiceCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            services<span class="token punctuation">.</span><span class="token function">AddMediator</span><span class="token punctuation">(</span>cfg <span class="token operator">=&gt;</span>
            <span class="token punctuation">{</span>
                cfg<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddConsumer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SubmitOrderConsumer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                cfg<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddConsumer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderStatusConsumer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> provider <span class="token operator">=</span> services<span class="token punctuation">.</span><span class="token function">BuildServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> mediator <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IMediator<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Guid</span> orderId <span class="token operator">=</span> NewId<span class="token punctuation">.</span><span class="token function">NextGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">await</span> mediator<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Send</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SubmitOrder<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> orderId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> client <span class="token operator">=</span> mediator<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CreateRequestClient</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>GetOrderStatus<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetResponse</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderStatus<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> orderId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Order Status: {0}&quot;</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>Status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><p>Consumers and sagas (including saga repositories) can be added, routing slip activities are not supported using mediator. Consumer and saga definitions are supported as well, but certain properties like <em>EndpointName</em> are ignored. Middleware components, including <em>UseMessageRetry</em> and <em>UseInMemoryOutbox</em>, are fully supported.</p> <p>Once created, Mediator doesn't need to be started or stopped and can be used immediately. <em>IMediator</em> combines several other interfaces into a single interface, including <em>IPublishEndpoint</em>, <em>ISendEndpoint</em>, and <em>IClientFactory</em>.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">namespace</span> <span class="token namespace">MassTransit<span class="token punctuation">.</span>Mediator</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IMediator</span> <span class="token punctuation">:</span>
        <span class="token type-list"><span class="token class-name">ISendEndpoint</span><span class="token punctuation">,</span>
        <span class="token class-name">IPublishEndpoint</span><span class="token punctuation">,</span>
        <span class="token class-name">IClientFactory</span><span class="token punctuation">,</span>
        <span class="token class-name">IConsumePipeConnector</span><span class="token punctuation">,</span>
        <span class="token class-name">IRequestPipeConnector</span><span class="token punctuation">,</span>
        <span class="token class-name">IConsumeObserverConnector</span><span class="token punctuation">,</span>
        <span class="token class-name">IConsumeMessageObserverConnector</span></span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>MassTransit dispatches the command to the consumer asynchronously. Once the <em>Consume</em> method completes, the <em>Send</em> method will complete. If the consumer throws an exception, it will be propagated back to the caller.</p> <div class="custom-block tip"><p class="custom-block-title">Send vs Publish</p> <p><em>Send</em> expects the message to be consumed. If there is no consumer configured for the message type, an exception will be thrown.</p> <p><em>Publish</em>, on the other hand, does not require the message to be consumed and does not throw an exception if the message isn't consumed. To throw an exception when a published message is not consumed, set the <em>Mandatory</em> property to <em>true</em> on <em>PublishContext</em>.</p></div> <h3 id="connect"><a href="#connect" class="header-anchor">#</a> Connect</h3> <p>Consumers can be connected and disconnected from mediator at run-time, allowing components and services to temporarily consume messages. Use the <em>ConnectConsumer</em> method to connect a consumer. The handle can be used to disconnect the consumer.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">namespace</span> <span class="token namespace">UsageMediatorConnect</span>
<span class="token punctuation">{</span>
    <span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">UsageConsumer</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>DependencyInjection</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">MassTransit</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">MassTransit<span class="token punctuation">.</span>Mediator</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">await</span> <span class="token keyword">using</span> <span class="token class-name"><span class="token keyword">var</span></span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServiceCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">AddMediator</span><span class="token punctuation">(</span>cfg <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">BuildServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> mediator <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IMediator<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> handle <span class="token operator">=</span> mediator<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ConnectConsumer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SubmitOrderConsumer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="requests"><a href="#requests" class="header-anchor">#</a> Requests</h3> <p>To send a request using the mediator, a request client can be created from <em>IMediator</em>. The example below configures two consumers and then sends the <em>SubmitOrder</em> command, followed by the <em>GetOrderStatus</em> request.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">namespace</span> <span class="token namespace">UsageMediatorRequest</span>
<span class="token punctuation">{</span>
    <span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">UsageContracts</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>DependencyInjection</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">UsageMediatorConsumer</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">MassTransit</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">MassTransit<span class="token punctuation">.</span>Mediator</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">await</span> <span class="token keyword">using</span> <span class="token class-name"><span class="token keyword">var</span></span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServiceCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">AddMediator</span><span class="token punctuation">(</span>cfg <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">BuildServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> mediator <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IMediator<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Guid</span> orderId <span class="token operator">=</span> NewId<span class="token punctuation">.</span><span class="token function">NextGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">await</span> mediator<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Send</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SubmitOrder<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> orderId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> client <span class="token operator">=</span> mediator<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CreateRequestClient</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>GetOrderStatus<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetResponse</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderStatus<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> orderId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Order Status: {0}&quot;</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>Status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The <em>OrderStatusConsumer</em>, along with the message contracts, is shown below.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">namespace</span> <span class="token namespace">UsageMediatorConsumer</span>
<span class="token punctuation">{</span>
    <span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">MassTransit</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">GetOrderStatus</span>
    <span class="token punctuation">{</span>
        <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderStatus</span>
    <span class="token punctuation">{</span>
        <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token return-type class-name"><span class="token keyword">string</span></span> Status <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">class</span> <span class="token class-name">OrderStatusConsumer</span> <span class="token punctuation">:</span>
        <span class="token type-list"><span class="token class-name">IConsumer<span class="token punctuation">&lt;</span>GetOrderStatus<span class="token punctuation">&gt;</span></span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Consume</span><span class="token punctuation">(</span><span class="token class-name">ConsumeContext<span class="token punctuation">&lt;</span>GetOrderStatus<span class="token punctuation">&gt;</span></span> context<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RespondAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderStatus<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> 
                <span class="token punctuation">{</span> 
                    context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId<span class="token punctuation">,</span> 
                    Status <span class="token operator">=</span> <span class="token string">&quot;Pending&quot;</span> 
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><p>Just like <em>Send</em>, the request is executed asynchronously. If an exception occurs, the exception will be propagated back to the caller. If the request times out, or if the request is canceled, the <em>GetResponse</em> method will throw an exception (either a <em>RequestTimeoutException</em> or an <em>OperationCanceledException</em>).</p> <h3 id="middleware"><a href="#middleware" class="header-anchor">#</a> Middleware</h3> <p>MassTransit Mediator is built using the same components used to create a bus, which means all the same middleware components can be configured. For instance, to configure the Mediator pipeline, such as adding a scoped filter, see the example below.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">namespace</span> <span class="token namespace">UsageMediatorConfigure</span>
<span class="token punctuation">{</span>
    <span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">UsageContracts</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">UsageConsumer</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">UsageMediatorConsumer</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">MassTransit</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">MassTransit<span class="token punctuation">.</span>Mediator</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>DependencyInjection</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ValidateOrderStatusFilter<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token punctuation">:</span>
        <span class="token type-list"><span class="token class-name">IFilter<span class="token punctuation">&lt;</span>SendContext<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span>
        <span class="token keyword">where</span> <span class="token class-name">T</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Probe</span><span class="token punctuation">(</span><span class="token class-name">ProbeContext</span> context<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name">Task</span> <span class="token function">Send</span><span class="token punctuation">(</span><span class="token class-name">SendContext<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> context<span class="token punctuation">,</span> <span class="token class-name">IPipe<span class="token punctuation">&lt;</span>SendContext<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> next<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>Message <span class="token keyword">is</span> <span class="token class-name">GetOrderStatus</span> getOrderStatus <span class="token operator">&amp;&amp;</span> getOrderStatus<span class="token punctuation">.</span>OrderId <span class="token operator">==</span> Guid<span class="token punctuation">.</span>Empty<span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;The OrderId must not be empty&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> next<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> services <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServiceCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            services<span class="token punctuation">.</span><span class="token function">AddMediator</span><span class="token punctuation">(</span>cfg <span class="token operator">=&gt;</span>
            <span class="token punctuation">{</span>
                cfg<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddConsumer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SubmitOrderConsumer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                cfg<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddConsumer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderStatusConsumer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                cfg<span class="token punctuation">.</span><span class="token function">ConfigureMediator</span><span class="token punctuation">(</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> mcfg<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
                <span class="token punctuation">{</span>
                    mcfg<span class="token punctuation">.</span><span class="token function">UseSendFilter</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">ValidateOrderStatusFilter<span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> provider <span class="token operator">=</span> services<span class="token punctuation">.</span><span class="token function">BuildServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> mediator <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IMediator<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Guid</span> orderId <span class="token operator">=</span> NewId<span class="token punctuation">.</span><span class="token function">NextGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">await</span> mediator<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Send</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SubmitOrder<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> orderId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> client <span class="token operator">=</span> mediator<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CreateRequestClient</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>GetOrderStatus<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetResponse</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderStatus<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> orderId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Order Status: {0}&quot;</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>Status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="http-context-scope"><a href="#http-context-scope" class="header-anchor">#</a> HTTP Context Scope</h3> <p>A common question lately has been around the use of MassTransit's Mediator with ASP.NET Core, specifically the scope created for controllers. In cases where it is desirable to use the same scope for Mediator consumers that was created by the controller, the <code>HttpContextScopeAccessor</code> can be used as shown below.</p> <p>First, to configure the scope accessor, add the following to the services configuration:</p> <div class="language-cs extra-class"><pre class="language-cs"><code>services<span class="token punctuation">.</span><span class="token function">AddHttpContextAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

services<span class="token punctuation">.</span><span class="token function">AddMediator</span><span class="token punctuation">(</span>configurator <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    configurator<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddConsumer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SampleMessageConsumer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    configurator<span class="token punctuation">.</span><span class="token function">ConfigureMediator</span><span class="token punctuation">(</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> cfg<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> cfg<span class="token punctuation">.</span><span class="token function">UseHttpContextScopeFilter</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The <code>UseHttpContextScopeFilter</code> is an extension method that needs to be added to the project:</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MediatorHttpContextScopeFilterExtensions</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">UseHttpContextScopeFilter</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IMediatorConfigurator</span> configurator<span class="token punctuation">,</span> <span class="token class-name">IServiceProvider</span> serviceProvider<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> filter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HttpContextScopeFilter</span><span class="token punctuation">(</span>serviceProvider<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IHttpContextAccessor<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        configurator<span class="token punctuation">.</span><span class="token function">ConfigurePublish</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token function">UseFilter</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        configurator<span class="token punctuation">.</span><span class="token function">ConfigureSend</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token function">UseFilter</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        configurator<span class="token punctuation">.</span><span class="token function">UseFilter</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The extension method uses the <code>HttpContextScopeFilter</code>, shown below, which also needs to be added to the project:</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HttpContextScopeFilter</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">IFilter<span class="token punctuation">&lt;</span>PublishContext<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span>
    <span class="token class-name">IFilter<span class="token punctuation">&lt;</span>SendContext<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span>
    <span class="token class-name">IFilter<span class="token punctuation">&lt;</span>ConsumeContext<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IHttpContextAccessor</span> _httpContextAccessor<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">HttpContextScopeFilter</span><span class="token punctuation">(</span><span class="token class-name">IHttpContextAccessor</span> httpContextAccessor<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _httpContextAccessor <span class="token operator">=</span> httpContextAccessor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AddPayload</span><span class="token punctuation">(</span><span class="token class-name">PipeContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_httpContextAccessor<span class="token punctuation">.</span>HttpContext <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> serviceProvider <span class="token operator">=</span> _httpContextAccessor<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>RequestServices<span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token function">GetOrAddPayload</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> serviceProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetOrAddPayload</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IServiceScope<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">NoopScope</span><span class="token punctuation">(</span>serviceProvider<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Task</span> <span class="token function">Send</span><span class="token punctuation">(</span><span class="token class-name">PublishContext</span> context<span class="token punctuation">,</span> <span class="token class-name">IPipe<span class="token punctuation">&lt;</span>PublishContext<span class="token punctuation">&gt;</span></span> next<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">AddPayload</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> next<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Task</span> <span class="token function">Send</span><span class="token punctuation">(</span><span class="token class-name">SendContext</span> context<span class="token punctuation">,</span> <span class="token class-name">IPipe<span class="token punctuation">&lt;</span>SendContext<span class="token punctuation">&gt;</span></span> next<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">AddPayload</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> next<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Task</span> <span class="token function">Send</span><span class="token punctuation">(</span><span class="token class-name">ConsumeContext</span> context<span class="token punctuation">,</span> <span class="token class-name">IPipe<span class="token punctuation">&lt;</span>ConsumeContext<span class="token punctuation">&gt;</span></span> next<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">AddPayload</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> next<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Probe</span><span class="token punctuation">(</span><span class="token class-name">ProbeContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">NoopScope</span> <span class="token punctuation">:</span>
        <span class="token type-list"><span class="token class-name">IServiceScope</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token function">NoopScope</span><span class="token punctuation">(</span><span class="token class-name">IServiceProvider</span> serviceProvider<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            ServiceProvider <span class="token operator">=</span> serviceProvider<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name">IServiceProvider</span> ServiceProvider <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Once the above have been added, the controller scope will be passed through the mediator send and consume filters so that the controller scope is used for the consumers.</p> <h3 id="legacy-configuration"><a href="#legacy-configuration" class="header-anchor">#</a> Legacy Configuration</h3> <p>When not using a container, Mediator can be created as shown below. Consumers and sagas are configured the same way they would on a receive endpoint. The example below configures the mediator with a single consumer.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">namespace</span> <span class="token namespace">UsageMediator</span>
<span class="token punctuation">{</span>
    <span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">UsageConsumer</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">MassTransit</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token namespace">MassTransit<span class="token punctuation">.</span>Mediator</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">IMediator</span> mediator <span class="token operator">=</span> Bus<span class="token punctuation">.</span>Factory<span class="token punctuation">.</span><span class="token function">CreateMediator</span><span class="token punctuation">(</span>cfg <span class="token operator">=&gt;</span>
            <span class="token punctuation">{</span>
                cfg<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Consumer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SubmitOrderConsumer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/MassTransit/MassTransit/edit/develop/docs/usage/mediator.md" target="_blank" rel="noopener noreferrer">Help us by improving this page!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/24/2022, 7:10:01 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/usage/faas/aws-lambda.html" class="prev">
        AWS Lambda
      </a></span> <span class="next"><a href="/usage/messages.html">
        Messages
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.0f717998.js" defer></script><script src="/assets/js/3.da322882.js" defer></script><script src="/assets/js/126.6c0ed471.js" defer></script>
  </body>
</html>
