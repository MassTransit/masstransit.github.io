<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Requests | MassTransit</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#3a0839">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="description" content="A free, open-source distributed application framework for .NET.">
    <meta name="msapplication-TileColor" content="#3a0839">
    <meta name="msapplication-config" content="/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    
    <link rel="preload" href="/assets/css/0.styles.af8ca635.css" as="style"><link rel="preload" href="/assets/js/app.0f717998.js" as="script"><link rel="preload" href="/assets/js/3.da322882.js" as="script"><link rel="preload" href="/assets/js/131.6e3916b7.js" as="script"><link rel="prefetch" href="/assets/js/10.941c3d0b.js"><link rel="prefetch" href="/assets/js/100.23f1c4ea.js"><link rel="prefetch" href="/assets/js/101.710aa7a5.js"><link rel="prefetch" href="/assets/js/102.827dba0e.js"><link rel="prefetch" href="/assets/js/103.fdd173f3.js"><link rel="prefetch" href="/assets/js/104.8c1a005f.js"><link rel="prefetch" href="/assets/js/105.95990127.js"><link rel="prefetch" href="/assets/js/106.c4b2015b.js"><link rel="prefetch" href="/assets/js/107.e0acc6f2.js"><link rel="prefetch" href="/assets/js/108.78eab687.js"><link rel="prefetch" href="/assets/js/109.b4d1a487.js"><link rel="prefetch" href="/assets/js/11.76406285.js"><link rel="prefetch" href="/assets/js/110.f0a83b63.js"><link rel="prefetch" href="/assets/js/111.3f22952e.js"><link rel="prefetch" href="/assets/js/112.1ad12ad5.js"><link rel="prefetch" href="/assets/js/113.40368044.js"><link rel="prefetch" href="/assets/js/114.3cd980b4.js"><link rel="prefetch" href="/assets/js/115.00f2166d.js"><link rel="prefetch" href="/assets/js/116.6670b5f2.js"><link rel="prefetch" href="/assets/js/117.4a42c861.js"><link rel="prefetch" href="/assets/js/118.e6410316.js"><link rel="prefetch" href="/assets/js/119.dd058ee6.js"><link rel="prefetch" href="/assets/js/12.4464da33.js"><link rel="prefetch" href="/assets/js/120.cccb363a.js"><link rel="prefetch" href="/assets/js/121.75e3ed75.js"><link rel="prefetch" href="/assets/js/122.ddb3d7e5.js"><link rel="prefetch" href="/assets/js/123.f7ca23b1.js"><link rel="prefetch" href="/assets/js/124.2e501680.js"><link rel="prefetch" href="/assets/js/125.4d5eeb88.js"><link rel="prefetch" href="/assets/js/126.6c0ed471.js"><link rel="prefetch" href="/assets/js/127.6d232467.js"><link rel="prefetch" href="/assets/js/128.7a780f23.js"><link rel="prefetch" href="/assets/js/129.7fda41f1.js"><link rel="prefetch" href="/assets/js/13.512e3537.js"><link rel="prefetch" href="/assets/js/130.19738da2.js"><link rel="prefetch" href="/assets/js/132.bdf944d1.js"><link rel="prefetch" href="/assets/js/133.bf0cdaf4.js"><link rel="prefetch" href="/assets/js/134.a24e70f8.js"><link rel="prefetch" href="/assets/js/135.3087f6fe.js"><link rel="prefetch" href="/assets/js/136.c0914ec3.js"><link rel="prefetch" href="/assets/js/137.adc2c79a.js"><link rel="prefetch" href="/assets/js/138.6300f157.js"><link rel="prefetch" href="/assets/js/139.b2f14afc.js"><link rel="prefetch" href="/assets/js/14.f3f541c4.js"><link rel="prefetch" href="/assets/js/140.66174436.js"><link rel="prefetch" href="/assets/js/141.548ac70e.js"><link rel="prefetch" href="/assets/js/142.31e46e2f.js"><link rel="prefetch" href="/assets/js/143.e450e37e.js"><link rel="prefetch" href="/assets/js/144.1a7bdf49.js"><link rel="prefetch" href="/assets/js/145.8bd22f33.js"><link rel="prefetch" href="/assets/js/146.e9cae417.js"><link rel="prefetch" href="/assets/js/147.99c43782.js"><link rel="prefetch" href="/assets/js/148.0001e2e5.js"><link rel="prefetch" href="/assets/js/149.8dd98593.js"><link rel="prefetch" href="/assets/js/15.5b1e58a2.js"><link rel="prefetch" href="/assets/js/150.576d606c.js"><link rel="prefetch" href="/assets/js/151.7ffc60f8.js"><link rel="prefetch" href="/assets/js/152.64603d5f.js"><link rel="prefetch" href="/assets/js/153.04273ceb.js"><link rel="prefetch" href="/assets/js/154.5ecb1789.js"><link rel="prefetch" href="/assets/js/155.2443a17f.js"><link rel="prefetch" href="/assets/js/156.89bc3ef2.js"><link rel="prefetch" href="/assets/js/157.d2092780.js"><link rel="prefetch" href="/assets/js/158.abc54fe2.js"><link rel="prefetch" href="/assets/js/159.f591dba4.js"><link rel="prefetch" href="/assets/js/16.b89c7882.js"><link rel="prefetch" href="/assets/js/17.8a846d9a.js"><link rel="prefetch" href="/assets/js/18.bd1ec876.js"><link rel="prefetch" href="/assets/js/19.00d1434f.js"><link rel="prefetch" href="/assets/js/20.384b5b5b.js"><link rel="prefetch" href="/assets/js/21.b1ed6e3f.js"><link rel="prefetch" href="/assets/js/22.f8fa29a7.js"><link rel="prefetch" href="/assets/js/23.d5d8e28e.js"><link rel="prefetch" href="/assets/js/24.0e4be943.js"><link rel="prefetch" href="/assets/js/25.d7ae1021.js"><link rel="prefetch" href="/assets/js/26.d7c52843.js"><link rel="prefetch" href="/assets/js/27.b8504be5.js"><link rel="prefetch" href="/assets/js/28.318c6322.js"><link rel="prefetch" href="/assets/js/29.eb49e807.js"><link rel="prefetch" href="/assets/js/30.9ff31a8a.js"><link rel="prefetch" href="/assets/js/31.f9836bae.js"><link rel="prefetch" href="/assets/js/32.4306b1f2.js"><link rel="prefetch" href="/assets/js/33.3cbf102a.js"><link rel="prefetch" href="/assets/js/34.82ea42b8.js"><link rel="prefetch" href="/assets/js/35.a4cf4586.js"><link rel="prefetch" href="/assets/js/36.c79bc776.js"><link rel="prefetch" href="/assets/js/37.93848c0f.js"><link rel="prefetch" href="/assets/js/38.aed8b2f5.js"><link rel="prefetch" href="/assets/js/39.0bd57e5e.js"><link rel="prefetch" href="/assets/js/4.37ee6b06.js"><link rel="prefetch" href="/assets/js/40.8a1415b1.js"><link rel="prefetch" href="/assets/js/41.d49c2efb.js"><link rel="prefetch" href="/assets/js/42.b7bbbaf6.js"><link rel="prefetch" href="/assets/js/43.87609deb.js"><link rel="prefetch" href="/assets/js/44.cee9abc3.js"><link rel="prefetch" href="/assets/js/45.55c4b4b6.js"><link rel="prefetch" href="/assets/js/46.fc3df9fc.js"><link rel="prefetch" href="/assets/js/47.126380a2.js"><link rel="prefetch" href="/assets/js/48.345456c9.js"><link rel="prefetch" href="/assets/js/49.cb212764.js"><link rel="prefetch" href="/assets/js/5.9fe86136.js"><link rel="prefetch" href="/assets/js/50.e2a625b8.js"><link rel="prefetch" href="/assets/js/51.a2301d85.js"><link rel="prefetch" href="/assets/js/52.7626f76b.js"><link rel="prefetch" href="/assets/js/53.6dcfb078.js"><link rel="prefetch" href="/assets/js/54.7d5b7906.js"><link rel="prefetch" href="/assets/js/55.2f161720.js"><link rel="prefetch" href="/assets/js/56.3baf6838.js"><link rel="prefetch" href="/assets/js/57.5952a2e8.js"><link rel="prefetch" href="/assets/js/58.35bd50d1.js"><link rel="prefetch" href="/assets/js/59.1a61c98b.js"><link rel="prefetch" href="/assets/js/6.ae895e4f.js"><link rel="prefetch" href="/assets/js/60.dde8f8f2.js"><link rel="prefetch" href="/assets/js/61.fc9b4fc0.js"><link rel="prefetch" href="/assets/js/62.a5b28645.js"><link rel="prefetch" href="/assets/js/63.16221e1a.js"><link rel="prefetch" href="/assets/js/64.573d11a6.js"><link rel="prefetch" href="/assets/js/65.0082a727.js"><link rel="prefetch" href="/assets/js/66.366ffe6e.js"><link rel="prefetch" href="/assets/js/67.2271d873.js"><link rel="prefetch" href="/assets/js/68.6cfc25bd.js"><link rel="prefetch" href="/assets/js/69.f91f0dae.js"><link rel="prefetch" href="/assets/js/7.77650bb5.js"><link rel="prefetch" href="/assets/js/70.9f842d94.js"><link rel="prefetch" href="/assets/js/71.f12cfc74.js"><link rel="prefetch" href="/assets/js/72.7c699f2b.js"><link rel="prefetch" href="/assets/js/73.2080b9dd.js"><link rel="prefetch" href="/assets/js/74.03ec3239.js"><link rel="prefetch" href="/assets/js/75.a2e95397.js"><link rel="prefetch" href="/assets/js/76.a8f91599.js"><link rel="prefetch" href="/assets/js/77.bb549269.js"><link rel="prefetch" href="/assets/js/78.56c8d184.js"><link rel="prefetch" href="/assets/js/79.99f38c6f.js"><link rel="prefetch" href="/assets/js/8.be925209.js"><link rel="prefetch" href="/assets/js/80.13f11752.js"><link rel="prefetch" href="/assets/js/81.028a7b5e.js"><link rel="prefetch" href="/assets/js/82.4956e61b.js"><link rel="prefetch" href="/assets/js/83.4efd0d82.js"><link rel="prefetch" href="/assets/js/84.e214e198.js"><link rel="prefetch" href="/assets/js/85.c935478c.js"><link rel="prefetch" href="/assets/js/86.bd6a9d11.js"><link rel="prefetch" href="/assets/js/87.47bd24e2.js"><link rel="prefetch" href="/assets/js/88.350bbf5d.js"><link rel="prefetch" href="/assets/js/89.32d2e3c2.js"><link rel="prefetch" href="/assets/js/9.b8c411bf.js"><link rel="prefetch" href="/assets/js/90.e0e9e669.js"><link rel="prefetch" href="/assets/js/91.a2c133e3.js"><link rel="prefetch" href="/assets/js/92.00ca9d52.js"><link rel="prefetch" href="/assets/js/93.70dcdd49.js"><link rel="prefetch" href="/assets/js/94.861c48fb.js"><link rel="prefetch" href="/assets/js/95.352fd642.js"><link rel="prefetch" href="/assets/js/96.e303cfc4.js"><link rel="prefetch" href="/assets/js/97.b5c87e83.js"><link rel="prefetch" href="/assets/js/98.1d3e5253.js"><link rel="prefetch" href="/assets/js/99.a0f7babd.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.ceb48f17.js">
    <link rel="stylesheet" href="/assets/css/0.styles.af8ca635.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/mt-logo-small.png" alt="MassTransit" class="logo"> <span class="site-name can-hide">MassTransit</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/discord.html" class="nav-link">
  Discord
</a></div><div class="nav-item"><a href="https://nuget.org/packages/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NuGet
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/discord.html" class="nav-link">
  Discord
</a></div><div class="nav-item"><a href="https://nuget.org/packages/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NuGet
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/getting-started/" class="sidebar-heading clickable"><span>Getting Started</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/getting-started/upgrade-v6.html" class="sidebar-link">Upgrading</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/releases/" class="sidebar-heading clickable"><span>Release Notes</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/usage/" class="sidebar-heading clickable router-link-active open"><span>Using MassTransit</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/usage/configuration.html" class="sidebar-link">Configuration</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/transports/" class="sidebar-heading clickable"><span>Transports</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/riders/" class="sidebar-heading clickable"><span>Riders</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/faas/" class="sidebar-heading clickable"><span>FaaS</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/usage/mediator.html" class="sidebar-link">Mediator</a></li><li><a href="/usage/messages.html" class="sidebar-link">Messages</a></li><li><a href="/usage/consumers.html" class="sidebar-link">Consumers</a></li><li><a href="/usage/producers.html" class="sidebar-link">Producers</a></li><li><a href="/usage/exceptions.html" class="sidebar-link">Exceptions</a></li><li><a href="/usage/requests.html" aria-current="page" class="active sidebar-link">Requests</a><ul class="sidebar-sub-headers"></ul></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/sagas/" class="sidebar-heading clickable"><span>Sagas</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/containers/" class="sidebar-heading clickable"><span>Containers</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/usage/testing.html" class="sidebar-link">Testing</a></li><li><a href="/usage/logging.html" class="sidebar-link">Logging</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Advanced</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/learn/" class="sidebar-heading clickable"><span>Getting Help</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Articles</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/platform/" class="sidebar-heading clickable"><span>Platform</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Reference</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="requests"><a href="#requests" class="header-anchor">#</a> Requests</h1> <p>Request/response is a common pattern in application development, where a component sends a request to a service and continues once the response is received. In a distributed system, this can increase the latency of an application since the service may be hosted in another process, on another machine, or may even be a remote service in another network. While in many cases it is best to avoid request/response use in distributed applications, particularly when the request is a command, it is often necessary and preferred over more complex solutions.</p> <p>Fortunately for .NET developers, C# with TPL makes it easier to program applications that call services asynchronously. By using <em>Tasks</em> and the <em>async</em> and <em>await</em> keywords, developers can write procedural code and avoid the complex use of callbacks and handlers. Additionally, multiple asynchronous requests can be executed at once, reducing the overall execution time to that of the longest request.</p> <h3 id="message-contracts"><a href="#message-contracts" class="header-anchor">#</a> Message Contracts</h3> <p>To get started, the message contracts need to be created. In this example, an order status check is being created.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CheckOrderStatus</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name"><span class="token keyword">string</span></span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderStatusResult</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name"><span class="token keyword">string</span></span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name">DateTime</span> Timestamp <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name"><span class="token keyword">short</span></span> StatusCode <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name"><span class="token keyword">string</span></span> StatusText <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="request-consumer"><a href="#request-consumer" class="header-anchor">#</a> Request Consumer</h3> <p>In order for the request to return anything, it needs to be handled. Handling requests is done by using normal consumers. The only difference is that such consumer needs to send a response back.</p> <p>For the aforementioned message contracts, the request handler can look like this:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CheckOrderStatusConsumer</span> <span class="token punctuation">:</span> 
    <span class="token type-list"><span class="token class-name">IConsumer<span class="token punctuation">&lt;</span>CheckOrderStatus<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">readonly</span> <span class="token class-name">IOrderRepository</span> _orderRepository<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">CheckOrderStatusConsumer</span><span class="token punctuation">(</span><span class="token class-name">IOrderRepository</span> orderRepository<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _orderRepository <span class="token operator">=</span> orderRepository<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Consume</span><span class="token punctuation">(</span><span class="token class-name">ConsumeContext<span class="token punctuation">&lt;</span>CheckOrderStatus<span class="token punctuation">&gt;</span></span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> order <span class="token operator">=</span> <span class="token keyword">await</span> _orderRepository<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>order <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">InvalidOperationException</span><span class="token punctuation">(</span><span class="token string">&quot;Order not found&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RespondAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderStatusResult<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> 
        <span class="token punctuation">{</span>
            OrderId <span class="token operator">=</span> order<span class="token punctuation">.</span>Id<span class="token punctuation">,</span>
            order<span class="token punctuation">.</span>Timestamp<span class="token punctuation">,</span>
            order<span class="token punctuation">.</span>StatusCode<span class="token punctuation">,</span>
            order<span class="token punctuation">.</span>StatusText
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The response will be sent back to the requester. In case the exception is thrown, MassTransit will create a <code>Fault&lt;CheckOrderStatus&gt;</code> message and send it back to the requester. The requester address is available in the consume context of the request message as <code>context.ResponseAddress</code>.</p> <h3 id="request-client-configuration"><a href="#request-client-configuration" class="header-anchor">#</a> Request Client Configuration</h3> <p>Most interactions of the request/response nature consist of four elements: the request arguments, the response values, exception handling, and the time to wait for a response. The .NET framework gives us one additional element, a <code>CancellationToken</code>, which can cancel waiting for the response (the request is still sent, and may be processed, the CancellationToken only cancels waiting for the response).</p> <p>MassTransit includes a request client which encapsulates the request/response messaging pattern.</p> <div class="custom-block tip"><p class="custom-block-title">V8</p> <p>By default, MassTransit registers a generic request client in the container that publishes requests using the default request parameters. The only time a request client needs to be manually configured is when a specific <em>DestinationAddress</em> or <em>Timeout</em> is specified.</p></div> <p>To configure the request client with a specific destination address, use the <code>AddRequestClient</code> method as shown below. The default request timeout may also be specified.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    services<span class="token punctuation">.</span><span class="token function">AddMassTransit</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        x<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddConsumer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>CheckOrderStatusConsumer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        x<span class="token punctuation">.</span><span class="token function">UsingInMemory</span><span class="token punctuation">(</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> cfg<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
            cfg<span class="token punctuation">.</span><span class="token function">ConfigureEndpoints</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ONLY required if the destination address must be specified</span>
        x<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddRequestClient</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>CheckOrderStatus<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Uri</span><span class="token punctuation">(</span><span class="token string">&quot;exchange:order-status&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">IMPORTANT</p> <p>The bus <em>must</em> be started, always. If requests are timing out, the bus is likely not started.
MassTransit registers a hosted service in the container, which is automatically started by the .NET Generic Host and ASP.NET Core.</p></div> <p>To use the request client, a controller (or a consumer) uses the client via a constructor dependency.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RequestController</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">Controller</span></span>
<span class="token punctuation">{</span>
    <span class="token class-name">IRequestClient<span class="token punctuation">&lt;</span>CheckOrderStatus<span class="token punctuation">&gt;</span></span> _client<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">RequestController</span><span class="token punctuation">(</span><span class="token class-name">IRequestClient<span class="token punctuation">&lt;</span>CheckOrderStatus<span class="token punctuation">&gt;</span></span> client<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _client <span class="token operator">=</span> client<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>ActionResult<span class="token punctuation">&gt;</span></span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> id<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token keyword">await</span> _client<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetResponse</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderStatusResult<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span>OrderId <span class="token operator">=</span> id<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">View</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The controller method will send the request and return the view once the response has been received.</p> <h3 id="request-headers"><a href="#request-headers" class="header-anchor">#</a> Request Headers</h3> <p>To create a request and add a header to the <code>SendContext</code>, use the callback overload as shown below.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetResponse</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderStatusResult<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> id <span class="token punctuation">}</span><span class="token punctuation">,</span> 
    context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span>Headers<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;tenant-id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;some-value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Calling the <code>GetResponse</code> method triggers the request to be sent, after which the caller awaits the response. To add additional response types, see below for the tuple syntax, or just add multiple <code>GetResponse</code> methods, passing <em>false</em> for the <em>readyToSend</em> parameter.</p> <h3 id="multiple-requests"><a href="#multiple-requests" class="header-anchor">#</a> Multiple Requests</h3> <p>If there were multiple requests to be performed, it is easy to wait on all results at the same time, benefiting from the concurrent operation.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RequestController</span> <span class="token punctuation">:</span> 
    <span class="token type-list"><span class="token class-name">Controller</span></span>
<span class="token punctuation">{</span>
    <span class="token class-name">IRequestClient<span class="token punctuation">&lt;</span>RequestA<span class="token punctuation">&gt;</span></span> _clientA<span class="token punctuation">;</span>
    <span class="token class-name">IRequestClient<span class="token punctuation">&lt;</span>RequestB<span class="token punctuation">&gt;</span></span> _clientB<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">RequestController</span><span class="token punctuation">(</span><span class="token class-name">IRequestClient<span class="token punctuation">&lt;</span>RequestA<span class="token punctuation">&gt;</span></span> clientA<span class="token punctuation">,</span> <span class="token class-name">IRequestClient<span class="token punctuation">&lt;</span>RequestB<span class="token punctuation">&gt;</span></span> clientB<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _clientA <span class="token operator">=</span> clientA<span class="token punctuation">;</span>
        _clientB <span class="token operator">=</span> clientB<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>ActionResult<span class="token punctuation">&gt;</span></span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> resultA <span class="token operator">=</span> _clientA<span class="token punctuation">.</span><span class="token function">GetResponse</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">RequestA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> resultB <span class="token operator">=</span> _clientB<span class="token punctuation">.</span><span class="token function">GetResponse</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">RequestB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">WhenAll</span><span class="token punctuation">(</span>resultA<span class="token punctuation">,</span> resultB<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> a <span class="token operator">=</span> <span class="token keyword">await</span> resultA<span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> b <span class="token operator">=</span> <span class="token keyword">await</span> resultB<span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> model <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Model</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>Message<span class="token punctuation">,</span> b<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">View</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The power of concurrency, for the win!</p> <h3 id="multiple-response-types"><a href="#multiple-response-types" class="header-anchor">#</a> Multiple Response Types</h3> <p>Another powerful feature with the request client is the ability support multiple (such as positive and negative) result types. For example, adding an <code>OrderNotFound</code> response type to the consumer as shown eliminates throwing an exception since a missing order isn't really a fault.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CheckOrderStatusConsumer</span> <span class="token punctuation">:</span> 
    <span class="token type-list"><span class="token class-name">IConsumer<span class="token punctuation">&lt;</span>CheckOrderStatus<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Consume</span><span class="token punctuation">(</span><span class="token class-name">ConsumeContext<span class="token punctuation">&lt;</span>CheckOrderStatus<span class="token punctuation">&gt;</span></span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> order <span class="token operator">=</span> <span class="token keyword">await</span> _orderRepository<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>order <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RespondAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderNotFound<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>        
            <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RespondAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderStatusResult<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> 
            <span class="token punctuation">{</span>
                OrderId <span class="token operator">=</span> order<span class="token punctuation">.</span>Id<span class="token punctuation">,</span>
                order<span class="token punctuation">.</span>Timestamp<span class="token punctuation">,</span>
                order<span class="token punctuation">.</span>StatusCode<span class="token punctuation">,</span>
                order<span class="token punctuation">.</span>StatusText
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The client can now wait for multiple response types (in this case, two) by using a little tuple magic.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetResponse</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderStatusResult<span class="token punctuation">,</span> OrderNotFound<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> id<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name">Response<span class="token punctuation">&lt;</span>OrderStatusResult<span class="token punctuation">&gt;</span></span> responseA<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// do something with the order</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name">Response<span class="token punctuation">&lt;</span>OrderNotFound<span class="token punctuation">&gt;</span></span> responseB<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// the order was not found</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This cleans up the processing, an eliminates the need to catch a <code>RequestFaultException</code>.</p> <p>It's also possible to use some of the switch expressions via deconstruction, but this requires the response variable to be explicitly specified as <code>Response</code>.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token class-name">Response</span> response <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetResponse</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderStatusResult<span class="token punctuation">,</span> OrderNotFound<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> id<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Using a regular switch statement</span>
<span class="token keyword">switch</span> <span class="token punctuation">(</span>response<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token class-name">OrderStatusResult</span> a<span class="token punctuation">)</span> responseA<span class="token punctuation">:</span>
        <span class="token comment">// order found</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token class-name">OrderNotFound</span> b<span class="token punctuation">)</span> responseB<span class="token punctuation">:</span>
        <span class="token comment">// order not found</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Or using a switch expression</span>
<span class="token class-name"><span class="token keyword">var</span></span> accepted <span class="token operator">=</span> response <span class="token keyword">switch</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token class-name">OrderStatusResult</span> a<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token class-name">OrderNotFound</span> b<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    _ <span class="token operator">=&gt;</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">InvalidOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="request-client-accept-response-types"><a href="#request-client-accept-response-types" class="header-anchor">#</a> Request Client Accept Response Types</h3> <p>The request client sets a message header, <code>MT-Request-AcceptType</code>, that contains the response types supported by the request client. This allows the request consumer to determine if the client can handle a response type, which can be useful as services evolve and new response types may be added to handle new conditions. For instance, if a consumer adds a new response type, such as <code>OrderAlreadyShipped</code>, if the response type isn't supported an exception may be thrown instead.</p> <p>To see this in code, check out the client code:</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetResponse</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderCanceled<span class="token punctuation">,</span> OrderNotFound<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancelOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name">Response<span class="token punctuation">&lt;</span>OrderCanceled<span class="token punctuation">&gt;</span></span> canceled<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name">Response<span class="token punctuation">&lt;</span>OrderNotFound<span class="token punctuation">&gt;</span></span> responseB<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">NotFound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The original consumer, prior to adding the new response type:</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Consume</span><span class="token punctuation">(</span><span class="token class-name">ConsumeContext<span class="token punctuation">&lt;</span>CancelOrder<span class="token punctuation">&gt;</span></span> context<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> order <span class="token operator">=</span> _repository<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>order <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ResponseAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderNotFound<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    order<span class="token punctuation">.</span><span class="token function">Cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RespondAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderCanceled<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now, the new consumer that checks if the order has already shipped:</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Consume</span><span class="token punctuation">(</span><span class="token class-name">ConsumeContext<span class="token punctuation">&lt;</span>CancelOrder<span class="token punctuation">&gt;</span></span> context<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> order <span class="token operator">=</span> _repository<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>order <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ResponseAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderNotFound<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span>HasShipped<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">IsResponseAccepted</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderAlreadyShipped<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RespondAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderAlreadyShipped<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId<span class="token punctuation">,</span> order<span class="token punctuation">.</span>ShipDate <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">InvalidOperationException</span><span class="token punctuation">(</span><span class="token string">&quot;The order has already shipped&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// to throw a RequestFaultException in the client</span>
    <span class="token punctuation">}</span>

    order<span class="token punctuation">.</span><span class="token function">Cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RespondAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderCanceled<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This way, the consumer can check the request client response types and act accordingly.</p> <div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>For backwards compatibility, if the new <code>MT-Request-AcceptType</code> header is not found, <code>IsResponseAccepted</code> will return true for all message types.</p></div> <h3 id="request-client-details"><a href="#request-client-details" class="header-anchor">#</a> Request Client Details</h3> <blockquote><p>The internals are documented for understanding, but what follows is optional reading. The above container-based configuration handles all the details to ensure the property context is used.</p></blockquote> <p>The request client is composed of two parts, a client factory, and a request client. The client factory is created from the bus, or a connected endpoint, and has the interface below (some overloads are omitted, but you get the idea).</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IClientFactory</span> 
<span class="token punctuation">{</span>
    <span class="token return-type class-name">IRequestClient<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">CreateRequestClient</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">ConsumeContext</span> context<span class="token punctuation">,</span> <span class="token class-name">Uri</span> destinationAddress<span class="token punctuation">,</span> <span class="token class-name">RequestTimeout</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">IRequestClient<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">CreateRequestClient</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">Uri</span> destinationAddress<span class="token punctuation">,</span> <span class="token class-name">RequestTimeout</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">RequestHandle<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">CreateRequest</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">T</span> request<span class="token punctuation">,</span> <span class="token class-name">Uri</span> destinationAddress<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">,</span> <span class="token class-name">RequestTimeout</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">RequestHandle<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">CreateRequest</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">ConsumeContext</span> context<span class="token punctuation">,</span> <span class="token class-name">T</span> request<span class="token punctuation">,</span> <span class="token class-name">Uri</span> destinationAddress<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">,</span> <span class="token class-name">RequestTimeout</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>As shown, the client factory can create a request client, or it can create a request directly. There are advantages to each approach, although it's typically best to create a request client and use it if possible. If a consumer is sending the request, a new client should be created for each message (and is handled automatically if you're using a dependency injection container and the container registration methods).</p> <p>To create a client factory, call <code>bus.CreateClientFactory</code> or <code>host.CreateClientFactory</code> -- after the bus has been started.</p> <p>The request client can be used to create requests (returning a <code>RequestHandle&lt;T&gt;</code>, which must be disposed after the request completes) or it can be used directly to send a request and get a response (asynchronously, of course).</p> <blockquote><p>Using <code>Create</code> returns a request handle, which can be used to set headers and other attributes of the request before it is sent.</p></blockquote> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IRequestClient<span class="token punctuation">&lt;</span>TRequest<span class="token punctuation">&gt;</span></span>
    <span class="token keyword">where</span> <span class="token class-name">TRequest</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">RequestHandle<span class="token punctuation">&lt;</span>TRequest<span class="token punctuation">&gt;</span></span> <span class="token function">Create</span><span class="token punctuation">(</span><span class="token class-name">TRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">,</span> <span class="token class-name">RequestTimeout</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>Response<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetResponse</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">,</span> <span class="token class-name">RequestTimeout</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="sending-a-request"><a href="#sending-a-request" class="header-anchor">#</a> Sending a Request</h3> <p>To create a request client, and use it to make a standalone request (not from a consumer, API controller, etc.):</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> serviceAddress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Uri</span><span class="token punctuation">(</span><span class="token string">&quot;rabbitmq://localhost/check-order-status&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> client <span class="token operator">=</span> bus<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CreateRequestClient</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>CheckOrderStatus<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>serviceAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetResponse</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderStatusResult<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> id<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The response type, <code>Response&lt;OrderStatusResult&gt;</code> includes the <em>MessageContext</em> from when the response was received, providing access to the message properties (such as <code>response.ConversationId</code>) and headers (<code>response.Headers</code>).</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/MassTransit/MassTransit/edit/develop/docs/usage/requests.md" target="_blank" rel="noopener noreferrer">Help us by improving this page!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/24/2022, 7:10:01 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      
      <a href="/usage/exceptions.html" class="prev">
        Exceptions
      </a></span> <span class="next"><a href="/usage/sagas/automatonymous.html">
        Automatonymous
      </a>
      
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.0f717998.js" defer></script><script src="/assets/js/3.da322882.js" defer></script><script src="/assets/js/131.6e3916b7.js" defer></script>
  </body>
</html>
