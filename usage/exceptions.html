<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Exceptions | MassTransit</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#3a0839">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="description" content="A free, open-source distributed application framework for .NET.">
    <meta name="msapplication-TileColor" content="#3a0839">
    <meta name="msapplication-config" content="/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    
    <link rel="preload" href="/assets/css/0.styles.af8ca635.css" as="style"><link rel="preload" href="/assets/js/app.0f717998.js" as="script"><link rel="preload" href="/assets/js/3.da322882.js" as="script"><link rel="preload" href="/assets/js/120.cccb363a.js" as="script"><link rel="prefetch" href="/assets/js/10.941c3d0b.js"><link rel="prefetch" href="/assets/js/100.23f1c4ea.js"><link rel="prefetch" href="/assets/js/101.710aa7a5.js"><link rel="prefetch" href="/assets/js/102.827dba0e.js"><link rel="prefetch" href="/assets/js/103.fdd173f3.js"><link rel="prefetch" href="/assets/js/104.8c1a005f.js"><link rel="prefetch" href="/assets/js/105.95990127.js"><link rel="prefetch" href="/assets/js/106.c4b2015b.js"><link rel="prefetch" href="/assets/js/107.e0acc6f2.js"><link rel="prefetch" href="/assets/js/108.78eab687.js"><link rel="prefetch" href="/assets/js/109.b4d1a487.js"><link rel="prefetch" href="/assets/js/11.76406285.js"><link rel="prefetch" href="/assets/js/110.f0a83b63.js"><link rel="prefetch" href="/assets/js/111.3f22952e.js"><link rel="prefetch" href="/assets/js/112.1ad12ad5.js"><link rel="prefetch" href="/assets/js/113.40368044.js"><link rel="prefetch" href="/assets/js/114.3cd980b4.js"><link rel="prefetch" href="/assets/js/115.00f2166d.js"><link rel="prefetch" href="/assets/js/116.6670b5f2.js"><link rel="prefetch" href="/assets/js/117.4a42c861.js"><link rel="prefetch" href="/assets/js/118.e6410316.js"><link rel="prefetch" href="/assets/js/119.dd058ee6.js"><link rel="prefetch" href="/assets/js/12.4464da33.js"><link rel="prefetch" href="/assets/js/121.75e3ed75.js"><link rel="prefetch" href="/assets/js/122.ddb3d7e5.js"><link rel="prefetch" href="/assets/js/123.f7ca23b1.js"><link rel="prefetch" href="/assets/js/124.2e501680.js"><link rel="prefetch" href="/assets/js/125.4d5eeb88.js"><link rel="prefetch" href="/assets/js/126.6c0ed471.js"><link rel="prefetch" href="/assets/js/127.6d232467.js"><link rel="prefetch" href="/assets/js/128.7a780f23.js"><link rel="prefetch" href="/assets/js/129.7fda41f1.js"><link rel="prefetch" href="/assets/js/13.512e3537.js"><link rel="prefetch" href="/assets/js/130.19738da2.js"><link rel="prefetch" href="/assets/js/131.6e3916b7.js"><link rel="prefetch" href="/assets/js/132.bdf944d1.js"><link rel="prefetch" href="/assets/js/133.bf0cdaf4.js"><link rel="prefetch" href="/assets/js/134.a24e70f8.js"><link rel="prefetch" href="/assets/js/135.3087f6fe.js"><link rel="prefetch" href="/assets/js/136.c0914ec3.js"><link rel="prefetch" href="/assets/js/137.adc2c79a.js"><link rel="prefetch" href="/assets/js/138.6300f157.js"><link rel="prefetch" href="/assets/js/139.b2f14afc.js"><link rel="prefetch" href="/assets/js/14.f3f541c4.js"><link rel="prefetch" href="/assets/js/140.66174436.js"><link rel="prefetch" href="/assets/js/141.548ac70e.js"><link rel="prefetch" href="/assets/js/142.31e46e2f.js"><link rel="prefetch" href="/assets/js/143.e450e37e.js"><link rel="prefetch" href="/assets/js/144.1a7bdf49.js"><link rel="prefetch" href="/assets/js/145.8bd22f33.js"><link rel="prefetch" href="/assets/js/146.e9cae417.js"><link rel="prefetch" href="/assets/js/147.99c43782.js"><link rel="prefetch" href="/assets/js/148.0001e2e5.js"><link rel="prefetch" href="/assets/js/149.8dd98593.js"><link rel="prefetch" href="/assets/js/15.5b1e58a2.js"><link rel="prefetch" href="/assets/js/150.576d606c.js"><link rel="prefetch" href="/assets/js/151.7ffc60f8.js"><link rel="prefetch" href="/assets/js/152.64603d5f.js"><link rel="prefetch" href="/assets/js/153.04273ceb.js"><link rel="prefetch" href="/assets/js/154.5ecb1789.js"><link rel="prefetch" href="/assets/js/155.2443a17f.js"><link rel="prefetch" href="/assets/js/156.89bc3ef2.js"><link rel="prefetch" href="/assets/js/157.d2092780.js"><link rel="prefetch" href="/assets/js/158.abc54fe2.js"><link rel="prefetch" href="/assets/js/159.f591dba4.js"><link rel="prefetch" href="/assets/js/16.b89c7882.js"><link rel="prefetch" href="/assets/js/17.8a846d9a.js"><link rel="prefetch" href="/assets/js/18.bd1ec876.js"><link rel="prefetch" href="/assets/js/19.00d1434f.js"><link rel="prefetch" href="/assets/js/20.384b5b5b.js"><link rel="prefetch" href="/assets/js/21.b1ed6e3f.js"><link rel="prefetch" href="/assets/js/22.f8fa29a7.js"><link rel="prefetch" href="/assets/js/23.d5d8e28e.js"><link rel="prefetch" href="/assets/js/24.0e4be943.js"><link rel="prefetch" href="/assets/js/25.d7ae1021.js"><link rel="prefetch" href="/assets/js/26.d7c52843.js"><link rel="prefetch" href="/assets/js/27.b8504be5.js"><link rel="prefetch" href="/assets/js/28.318c6322.js"><link rel="prefetch" href="/assets/js/29.eb49e807.js"><link rel="prefetch" href="/assets/js/30.9ff31a8a.js"><link rel="prefetch" href="/assets/js/31.f9836bae.js"><link rel="prefetch" href="/assets/js/32.4306b1f2.js"><link rel="prefetch" href="/assets/js/33.3cbf102a.js"><link rel="prefetch" href="/assets/js/34.82ea42b8.js"><link rel="prefetch" href="/assets/js/35.a4cf4586.js"><link rel="prefetch" href="/assets/js/36.c79bc776.js"><link rel="prefetch" href="/assets/js/37.93848c0f.js"><link rel="prefetch" href="/assets/js/38.aed8b2f5.js"><link rel="prefetch" href="/assets/js/39.0bd57e5e.js"><link rel="prefetch" href="/assets/js/4.37ee6b06.js"><link rel="prefetch" href="/assets/js/40.8a1415b1.js"><link rel="prefetch" href="/assets/js/41.d49c2efb.js"><link rel="prefetch" href="/assets/js/42.b7bbbaf6.js"><link rel="prefetch" href="/assets/js/43.87609deb.js"><link rel="prefetch" href="/assets/js/44.cee9abc3.js"><link rel="prefetch" href="/assets/js/45.55c4b4b6.js"><link rel="prefetch" href="/assets/js/46.fc3df9fc.js"><link rel="prefetch" href="/assets/js/47.126380a2.js"><link rel="prefetch" href="/assets/js/48.345456c9.js"><link rel="prefetch" href="/assets/js/49.cb212764.js"><link rel="prefetch" href="/assets/js/5.9fe86136.js"><link rel="prefetch" href="/assets/js/50.e2a625b8.js"><link rel="prefetch" href="/assets/js/51.a2301d85.js"><link rel="prefetch" href="/assets/js/52.7626f76b.js"><link rel="prefetch" href="/assets/js/53.6dcfb078.js"><link rel="prefetch" href="/assets/js/54.7d5b7906.js"><link rel="prefetch" href="/assets/js/55.2f161720.js"><link rel="prefetch" href="/assets/js/56.3baf6838.js"><link rel="prefetch" href="/assets/js/57.5952a2e8.js"><link rel="prefetch" href="/assets/js/58.35bd50d1.js"><link rel="prefetch" href="/assets/js/59.1a61c98b.js"><link rel="prefetch" href="/assets/js/6.ae895e4f.js"><link rel="prefetch" href="/assets/js/60.dde8f8f2.js"><link rel="prefetch" href="/assets/js/61.fc9b4fc0.js"><link rel="prefetch" href="/assets/js/62.a5b28645.js"><link rel="prefetch" href="/assets/js/63.16221e1a.js"><link rel="prefetch" href="/assets/js/64.573d11a6.js"><link rel="prefetch" href="/assets/js/65.0082a727.js"><link rel="prefetch" href="/assets/js/66.366ffe6e.js"><link rel="prefetch" href="/assets/js/67.2271d873.js"><link rel="prefetch" href="/assets/js/68.6cfc25bd.js"><link rel="prefetch" href="/assets/js/69.f91f0dae.js"><link rel="prefetch" href="/assets/js/7.77650bb5.js"><link rel="prefetch" href="/assets/js/70.9f842d94.js"><link rel="prefetch" href="/assets/js/71.f12cfc74.js"><link rel="prefetch" href="/assets/js/72.7c699f2b.js"><link rel="prefetch" href="/assets/js/73.2080b9dd.js"><link rel="prefetch" href="/assets/js/74.03ec3239.js"><link rel="prefetch" href="/assets/js/75.a2e95397.js"><link rel="prefetch" href="/assets/js/76.a8f91599.js"><link rel="prefetch" href="/assets/js/77.bb549269.js"><link rel="prefetch" href="/assets/js/78.56c8d184.js"><link rel="prefetch" href="/assets/js/79.99f38c6f.js"><link rel="prefetch" href="/assets/js/8.be925209.js"><link rel="prefetch" href="/assets/js/80.13f11752.js"><link rel="prefetch" href="/assets/js/81.028a7b5e.js"><link rel="prefetch" href="/assets/js/82.4956e61b.js"><link rel="prefetch" href="/assets/js/83.4efd0d82.js"><link rel="prefetch" href="/assets/js/84.e214e198.js"><link rel="prefetch" href="/assets/js/85.c935478c.js"><link rel="prefetch" href="/assets/js/86.bd6a9d11.js"><link rel="prefetch" href="/assets/js/87.47bd24e2.js"><link rel="prefetch" href="/assets/js/88.350bbf5d.js"><link rel="prefetch" href="/assets/js/89.32d2e3c2.js"><link rel="prefetch" href="/assets/js/9.b8c411bf.js"><link rel="prefetch" href="/assets/js/90.e0e9e669.js"><link rel="prefetch" href="/assets/js/91.a2c133e3.js"><link rel="prefetch" href="/assets/js/92.00ca9d52.js"><link rel="prefetch" href="/assets/js/93.70dcdd49.js"><link rel="prefetch" href="/assets/js/94.861c48fb.js"><link rel="prefetch" href="/assets/js/95.352fd642.js"><link rel="prefetch" href="/assets/js/96.e303cfc4.js"><link rel="prefetch" href="/assets/js/97.b5c87e83.js"><link rel="prefetch" href="/assets/js/98.1d3e5253.js"><link rel="prefetch" href="/assets/js/99.a0f7babd.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.ceb48f17.js">
    <link rel="stylesheet" href="/assets/css/0.styles.af8ca635.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/mt-logo-small.png" alt="MassTransit" class="logo"> <span class="site-name can-hide">MassTransit</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/discord.html" class="nav-link">
  Discord
</a></div><div class="nav-item"><a href="https://nuget.org/packages/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NuGet
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/discord.html" class="nav-link">
  Discord
</a></div><div class="nav-item"><a href="https://nuget.org/packages/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NuGet
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/getting-started/" class="sidebar-heading clickable"><span>Getting Started</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/getting-started/upgrade-v6.html" class="sidebar-link">Upgrading</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/releases/" class="sidebar-heading clickable"><span>Release Notes</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/usage/" class="sidebar-heading clickable router-link-active open"><span>Using MassTransit</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/usage/configuration.html" class="sidebar-link">Configuration</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/transports/" class="sidebar-heading clickable"><span>Transports</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/riders/" class="sidebar-heading clickable"><span>Riders</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/faas/" class="sidebar-heading clickable"><span>FaaS</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/usage/mediator.html" class="sidebar-link">Mediator</a></li><li><a href="/usage/messages.html" class="sidebar-link">Messages</a></li><li><a href="/usage/consumers.html" class="sidebar-link">Consumers</a></li><li><a href="/usage/producers.html" class="sidebar-link">Producers</a></li><li><a href="/usage/exceptions.html" aria-current="page" class="active sidebar-link">Exceptions</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/usage/exceptions.html#retry" class="sidebar-link">Retry</a></li><li class="sidebar-sub-header"><a href="/usage/exceptions.html#retry-configuration" class="sidebar-link">Retry Configuration</a></li><li class="sidebar-sub-header"><a href="/usage/exceptions.html#redelivery" class="sidebar-link">Redelivery</a></li><li class="sidebar-sub-header"><a href="/usage/exceptions.html#outbox" class="sidebar-link">Outbox</a></li><li class="sidebar-sub-header"><a href="/usage/exceptions.html#faults" class="sidebar-link">Faults</a></li><li class="sidebar-sub-header"><a href="/usage/exceptions.html#error-pipe" class="sidebar-link">Error Pipe</a></li><li class="sidebar-sub-header"><a href="/usage/exceptions.html#dead-letter-pipe" class="sidebar-link">Dead-Letter Pipe</a></li></ul></li><li><a href="/usage/requests.html" class="sidebar-link">Requests</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/sagas/" class="sidebar-heading clickable"><span>Sagas</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/containers/" class="sidebar-heading clickable"><span>Containers</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/usage/testing.html" class="sidebar-link">Testing</a></li><li><a href="/usage/logging.html" class="sidebar-link">Logging</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Advanced</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/learn/" class="sidebar-heading clickable"><span>Getting Help</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Articles</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/platform/" class="sidebar-heading clickable"><span>Platform</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Reference</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="exceptions"><a href="#exceptions" class="header-anchor">#</a> Exceptions</h1> <p>Let's face it, bad things happen. Networks partition, servers crash, remote endpoints become non-responsive. And when bad things happen, exceptions get thrown. And when exceptions get thrown, people die. Okay, maybe that's a bit dramatic, but the point is, exceptions are a fact of software development.</p> <p>Fortunately, MassTransit provides a number of features to help your application recover from and deal with exceptions. But before getting into that, an understanding of what happens when a message is consumed is needed.</p> <p>Take, for example, a consumer that simply throws an exception.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SubmitOrderConsumer</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">IConsumer<span class="token punctuation">&lt;</span>SubmitOrder<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Task</span> <span class="token function">Consume</span><span class="token punctuation">(</span><span class="token class-name">ConsumeContext<span class="token punctuation">&lt;</span>SubmitOrder<span class="token punctuation">&gt;</span></span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;Very bad things happened&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>When a message is delivered to the consumer, the consumer throws an exception. With a default bus configuration, the exception is caught by middleware in the transport (the <code>ErrorTransportFilter</code> to be exact), and the message is moved to an <em>_error</em> queue (prefixed by the receive endpoint queue name). The exception details are stored as headers with the message for analysis and to assist in troubleshooting the exception.</p> <div class="custom-block tip"><p class="custom-block-title">Video</p> <p>Learn about the error queue in <a href="https://youtu.be/3TMKUu7c4lc" target="_blank" rel="noopener noreferrer">this short video<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></div> <blockquote><p>In addition to moving the message to an error queue, MassTransit also produces a <code>Fault&lt;T&gt;</code> event. See below for more details on <em>faults</em>.</p></blockquote> <h2 id="retry"><a href="#retry" class="header-anchor">#</a> Retry</h2> <p>Some exceptions may be caused by a transient condition, such as a database deadlock, a busy web service, or some similar type of situation which usually clears up on a second attempt. With these exception types, it is often desirable to retry the message delivery to the consumer, allowing the consumer to try the operation again.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SubmitOrderConsumer</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">IConsumer<span class="token punctuation">&lt;</span>SubmitOrder<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token class-name">ISessionFactory</span> _sessionFactory<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Consume</span><span class="token punctuation">(</span><span class="token class-name">ConsumeContext<span class="token punctuation">&lt;</span>SubmitOrder<span class="token punctuation">&gt;</span></span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">using</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> session <span class="token operator">=</span> _sessionFactory<span class="token punctuation">.</span><span class="token function">OpenSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">using</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> transaction <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">BeginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> customer <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Get</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Customer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>CustomerId<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// continue with order processing</span>

            transaction<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>With this consumer, an <code>ADOException</code> can be thrown, say there is a deadlock or the SQL server is unavailable. In this case, the operation should be retried before moving the message to the error queue. This can be configured on the receive endpoint or the consumer. Shown below is a retry policy which attempts to deliver the message to a consumer five times before throwing the exception back up the pipeline.</p> <div class="language-cs extra-class"><pre class="language-cs"><code>services<span class="token punctuation">.</span><span class="token function">AddMassTransit</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    x<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddConsumer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SubmitOrderConsumer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    x<span class="token punctuation">.</span><span class="token function">UsingRabbitMq</span><span class="token punctuation">(</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span>cfg<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        cfg<span class="token punctuation">.</span><span class="token function">UseMessageRetry</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">Immediate</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        cfg<span class="token punctuation">.</span><span class="token function">ConfigureEndpoints</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The <code>UseMessageRetry</code> method is an extension method that configures a middleware filter, in this case the <code>RetryFilter</code>. There are a variety of retry policies available, which are detailed in the <a href="#retry-configuration">section below</a>.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>In this example, the <i>UseMessageRetry</i> is at the bus level, and will be configured on every receive endpoint. Additional retry filters can be added at the bus and consumer level, providing flexibility in how different consumers, messages, etc. are retried.</p></div> <p>To configure retry on a manually configured receive endpoint:</p> <div class="language-cs extra-class"><pre class="language-cs"><code>services<span class="token punctuation">.</span><span class="token function">AddMassTransit</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    x<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddConsumer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SubmitOrderConsumer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    x<span class="token punctuation">.</span><span class="token function">UsingRabbitMq</span><span class="token punctuation">(</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> cfg<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        cfg<span class="token punctuation">.</span><span class="token function">ReceiveEndpoint</span><span class="token punctuation">(</span><span class="token string">&quot;submit-order&quot;</span><span class="token punctuation">,</span> e <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">UseMessageRetry</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">Immediate</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            e<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ConfigureConsumer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SubmitOrderConsumer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>MassTransit retry filters execute in memory and maintain a <em>lock</em> on the message. As such, they should only be used to handle short, transient error conditions. Setting a retry interval of an hour would fall into the category of <em>bad things</em>. To retry messages after longer waits, look at the next section on redelivering messages.</p> <h2 id="retry-configuration"><a href="#retry-configuration" class="header-anchor">#</a> Retry Configuration</h2> <div class="custom-block tip"><p class="custom-block-title">Video</p> <p>Learn how to configure message retry in <a href="https://youtu.be/pKxf6Ii-3ow" target="_blank" rel="noopener noreferrer">this short video<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></div> <p>When configuring message retry, there are several retry policies available, including:</p> <table><thead><tr><th style="text-align:left;">Policy</th> <th style="text-align:left;">Description</th></tr></thead> <tbody><tr><td style="text-align:left;">None</td> <td style="text-align:left;">No retry</td></tr> <tr><td style="text-align:left;">Immediate</td> <td style="text-align:left;">Retry immediately, up to the retry limit</td></tr> <tr><td style="text-align:left;">Interval</td> <td style="text-align:left;">Retry after a fixed delay, up to the retry limit</td></tr> <tr><td style="text-align:left;">Intervals</td> <td style="text-align:left;">Retry after a delay, for each interval specified</td></tr> <tr><td style="text-align:left;">Exponential</td> <td style="text-align:left;">Retry after an exponentially increasing delay, up to the retry limit</td></tr> <tr><td style="text-align:left;">Incremental</td> <td style="text-align:left;">Retry after a steadily increasing delay, up to the retry limit</td></tr></tbody></table> <p>Each policy has configuration settings which specifies the expected behavior.</p> <h3 id="exception-filters"><a href="#exception-filters" class="header-anchor">#</a> Exception Filters</h3> <p>Sometimes you do not want to always retry, but instead only retry when some specific exception is thrown and fault for all other exceptions. To implement this, you can use an exception filter. Specify exception types using either the <code>Handle</code> or <code>Ignore</code> method. A filter can have either <em>Handle</em> or <em>Ignore</em> statements, combining them has unpredictable effects.</p> <p>Both methods have two signatures:</p> <ol><li><p>Generic version <code>Handle&lt;T&gt;</code> and <code>Ignore&lt;T&gt;</code> where <code>T</code> must be derivate of  <code>System.Exception</code>. With no argument, all exceptions of specified type will be either handled or ignored. You can also specify a function argument that will filter exceptions further based on other parameters.</p></li> <li><p>Non-generic version that needs one or more exception types as parameters. No further filtering is possible if this version is used.</p></li></ol> <p>You can use multiple calls to these methods to specify filters for multiple exception types:</p> <div class="language-cs extra-class"><pre class="language-cs"><code>e<span class="token punctuation">.</span><span class="token function">UseMessageRetry</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span> 
<span class="token punctuation">{</span>
    r<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Handle</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ArgumentNullException<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    r<span class="token punctuation">.</span><span class="token function">Ignore</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">InvalidOperationException</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">InvalidCastException</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    r<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Ignore</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ArgumentException<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>t <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>ParamName <span class="token operator">==</span> <span class="token string">&quot;orderTotal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>You can also specify multiple retry policies for a single endpoint:</p> <div class="language-cs extra-class"><pre class="language-cs"><code>services<span class="token punctuation">.</span><span class="token function">AddMassTransit</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    x<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddConsumer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SubmitOrderConsumer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    x<span class="token punctuation">.</span><span class="token function">UsingRabbitMq</span><span class="token punctuation">(</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> cfg<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        cfg<span class="token punctuation">.</span><span class="token function">ReceiveEndpoint</span><span class="token punctuation">(</span><span class="token string">&quot;submit-order&quot;</span><span class="token punctuation">,</span> e <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">UseMessageRetry</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span> 
            <span class="token punctuation">{</span>
                r<span class="token punctuation">.</span><span class="token function">Immediate</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                r<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Handle</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>DataException<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Message<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span><span class="token string">&quot;SQL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            e<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ConfigureConsumer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SubmitOrderConsumer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> c <span class="token operator">=&gt;</span> c<span class="token punctuation">.</span><span class="token function">UseMessageRetry</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span> 
            <span class="token punctuation">{</span>
                r<span class="token punctuation">.</span><span class="token function">Interval</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromMilliseconds</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                r<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Ignore</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ArgumentNullException<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                r<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Ignore</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>DataException<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Message<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span><span class="token string">&quot;SQL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>In the above example, if the consumer throws an <code>ArgumentNullException</code> it won't be retried (because it would obvious fail again, most likely). If a <code>DataException</code> is thrown matching the filter expression, it wouldn't be handled by the second retry filter, but would be handled by the first retry filter.</p> <h2 id="redelivery"><a href="#redelivery" class="header-anchor">#</a> Redelivery</h2> <p>Some errors take a while to resolve, say a remote service is down or a SQL server has crashed. In these situations, it's best to dust off and nuke the site from orbit - at a much later time obviously. Redelivery is a form of retry (some refer to it as <em>second-level retry</em>) where the message is removed from the queue and then redelivered to the queue at a future time.</p> <div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>In some frameworks, message redelivery is also referred to as second-level retry.</p></div> <p>To use delayed redelivery, ensure the transport is properly configured. RabbitMQ required a delayed-exchange plug-in, and ActiveMQ (non-Artemis) requires the scheduler to be enabled via the XML configuration.</p> <div class="language-cs extra-class"><pre class="language-cs"><code>services<span class="token punctuation">.</span><span class="token function">AddMassTransit</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    x<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddConsumer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SubmitOrderConsumer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    x<span class="token punctuation">.</span><span class="token function">UsingRabbitMq</span><span class="token punctuation">(</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> cfg<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        cfg<span class="token punctuation">.</span><span class="token function">UseDelayedRedelivery</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">Intervals</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromMinutes</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromMinutes</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromMinutes</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cfg<span class="token punctuation">.</span><span class="token function">UseMessageRetry</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">Immediate</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        cfg<span class="token punctuation">.</span><span class="token function">ConfigureEndpoints</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Now, if the initial 5 immediate retries fail (the database is really, really down), the message will retry an additional three times after 5, 15, and 30 minutes. This could mean a total of 15 retry attempts (on top of the initial 4 attempts prior to the retry/redelivery filters taking control).</p> <div class="custom-block tip"><p class="custom-block-title">Scheduled Redelivery</p> <p>MassTransit also supports scheduled redelivery using the <code>UseScheduledRedelivery</code> configuration method. Scheduled redelivery requires the use of a message scheduler, which can be configured to use the message transport or Quartz.NET/Hangfire. The configuration is similar, just ensure the scheduler is properly configured.</p></div> <h2 id="outbox"><a href="#outbox" class="header-anchor">#</a> Outbox</h2> <p>If the consumer publishes events or sends messages (using <code>ConsumeContext</code>, which is provided via the <code>Consume</code> method on the consumer) and subsequently throws an exception, it isn't likely that those messages should still be published or sent. MassTransit provides an outbox to buffer those messages until the consumer completes successfully. If an exception is thrown, the buffered messages are discarded.</p> <p>To configure the outbox with redelivery and retry:</p> <div class="language-cs extra-class"><pre class="language-cs"><code>services<span class="token punctuation">.</span><span class="token function">AddMassTransit</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    x<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddConsumer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SubmitOrderConsumer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    x<span class="token punctuation">.</span><span class="token function">UsingRabbitMq</span><span class="token punctuation">(</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> cfg<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        cfg<span class="token punctuation">.</span><span class="token function">UseDelayedRedelivery</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">Intervals</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromMinutes</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromMinutes</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromMinutes</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cfg<span class="token punctuation">.</span><span class="token function">UseMessageRetry</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">Immediate</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cfg<span class="token punctuation">.</span><span class="token function">UseInMemoryOutbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        cfg<span class="token punctuation">.</span><span class="token function">ConfigureEndpoints</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="configuring-for-a-consumer-or-saga"><a href="#configuring-for-a-consumer-or-saga" class="header-anchor">#</a> Configuring for a consumer or saga</h3> <p>If there are multiple consumers (or saga) on the same endpoint (which could potentially get you on the <em>naughty list</em>), and the retry/redelivery behavior should only apply to a specific consumer or saga, the same configuration can be applied specifically to the consumer or saga.</p> <p>To configure a specific consumer.</p> <div class="language-cs extra-class"><pre class="language-cs"><code>services<span class="token punctuation">.</span><span class="token function">AddMassTransit</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    x<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddConsumer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SubmitOrderConsumer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    x<span class="token punctuation">.</span><span class="token function">UsingRabbitMq</span><span class="token punctuation">(</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> cfg<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        cfg<span class="token punctuation">.</span><span class="token function">ReceiveEndpoint</span><span class="token punctuation">(</span><span class="token string">&quot;submit-order&quot;</span><span class="token punctuation">,</span> e <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ConfigureConsumer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SubmitOrderConsumer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> c <span class="token operator">=&gt;</span>
            <span class="token punctuation">{</span>
                c<span class="token punctuation">.</span><span class="token function">UseDelayedRedelivery</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">Intervals</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromMinutes</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromMinutes</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromMinutes</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                c<span class="token punctuation">.</span><span class="token function">UseMessageRetry</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">Immediate</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                c<span class="token punctuation">.</span><span class="token function">UseInMemoryOutbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Sagas are configured in the same way, using the saga configurator.</p> <h2 id="faults"><a href="#faults" class="header-anchor">#</a> Faults</h2> <p>As shown above, MassTransit delivers messages to consumers by calling the <em>Consume</em> method. When a message consumer throws an exception instead of returning normally, a <code>Fault&lt;T&gt;</code> is produced, which may be published or sent depending upon the context.</p> <p>A <code>Fault&lt;T&gt;</code> is a generic message contract including the original message that caused the consumer to fail, as well as the <code>ExceptionInfo</code>, <code>HostInfo</code>, and the time of the exception.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Fault<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span>
    <span class="token keyword">where</span> <span class="token class-name">T</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">Guid</span> FaultId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name">Guid<span class="token punctuation">?</span></span> FaultedMessageId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name">DateTime</span> Timestamp <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name">ExceptionInfo<span class="token punctuation">[</span><span class="token punctuation">]</span></span> Exceptions <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name">HostInfo</span> Host <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name">T</span> Message <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>If the message headers specify a <code>FaultAddress</code>, the fault is sent directly to that address. If the <em>FaultAddress</em> is not present, but a <code>ResponseAddress</code> is specified, the fault is sent to the response address. Otherwise, the fault is published, allowing any subscribed consumers to receive it.</p> <h3 id="consuming-faults"><a href="#consuming-faults" class="header-anchor">#</a> Consuming Faults</h3> <p>Developers may want to do something with faults, such as updating an operational dashboard. To observe faults separate of the consumer that caused the fault to be produced, a consumer can consume fault messages the same as any other message.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DashboardFaultConsumer</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">IConsumer<span class="token punctuation">&lt;</span>Fault<span class="token punctuation">&lt;</span>SubmitOrder<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Consume</span><span class="token punctuation">(</span><span class="token class-name">ConsumeContext<span class="token punctuation">&lt;</span>Fault<span class="token punctuation">&lt;</span>SubmitOrder<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// update the dashboard</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Faults can also be observed by state machines when specified as an event:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token function">Event</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> SubmitOrderFaulted<span class="token punctuation">,</span> x <span class="token operator">=&gt;</span> x
    <span class="token punctuation">.</span><span class="token function">CorrelateById</span><span class="token punctuation">(</span>m <span class="token operator">=&gt;</span> m<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId<span class="token punctuation">)</span> <span class="token comment">// Fault&lt;T&gt; includes the original message</span>
    <span class="token punctuation">.</span><span class="token function">SelectId</span><span class="token punctuation">(</span>m <span class="token operator">=&gt;</span> m<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token return-type class-name">Event<span class="token punctuation">&lt;</span>Fault<span class="token punctuation">&lt;</span>SubmitOrder<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> SubmitOrderFaulted <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre></div><h2 id="error-pipe"><a href="#error-pipe" class="header-anchor">#</a> Error Pipe</h2> <p>By default, MassTransit will move faulted messages to the <em>_error</em> queue. This behavior can be customized for each receive endpoint.</p> <p>To discard faulted messages so that they are <em>not</em> moved to the <em>_error</em> queue:</p> <div class="language-cs extra-class"><pre class="language-cs"><code>cfg<span class="token punctuation">.</span><span class="token function">ReceiveEndpoint</span><span class="token punctuation">(</span><span class="token string">&quot;input-queue&quot;</span><span class="token punctuation">,</span> ec <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    ec<span class="token punctuation">.</span><span class="token function">DiscardFaultedMessages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Beyond that built-in customization, the individual filters can be added/configured as well. Shown below are the default filters, as an example.</p> <blockquote><p>This is by default, do <em>NOT</em> configure this unless you have a reason to change the behavior.</p></blockquote> <div class="language-cs extra-class"><pre class="language-cs"><code>cfg<span class="token punctuation">.</span><span class="token function">ReceiveEndpoint</span><span class="token punctuation">(</span><span class="token string">&quot;input-queue&quot;</span><span class="token punctuation">,</span> ec <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    ec<span class="token punctuation">.</span><span class="token function">ConfigureError</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        x<span class="token punctuation">.</span><span class="token function">UseFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">GenerateFaultFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        x<span class="token punctuation">.</span><span class="token function">UseFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ErrorTransportFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="dead-letter-pipe"><a href="#dead-letter-pipe" class="header-anchor">#</a> Dead-Letter Pipe</h2> <p>By default, MassTransit will move skipped messages to the <em>_skipped</em> queue. This behavior can be customized for each receive endpoint.</p> <blockquote><p>Skipped messages are messages that are read from the receive endpoint queue that do not have a matching handler, consumer, saga, etc. configured. For instance, receiving a <em>SubmitOrder</em> message on a receive endpoint that only has a consumer for the <em>UpdateOrder</em> message would cause that <em>SubmitOrder</em> message to end up in the <em>_skipped</em> queue.</p></blockquote> <p>To discard skipped messages so they are <em>not</em> moved to the <em>_skipped</em> queue:</p> <div class="language-cs extra-class"><pre class="language-cs"><code>cfg<span class="token punctuation">.</span><span class="token function">ReceiveEndpoint</span><span class="token punctuation">(</span><span class="token string">&quot;input-queue&quot;</span><span class="token punctuation">,</span> ec <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    ec<span class="token punctuation">.</span><span class="token function">DiscardSkippedMessages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Beyond that built-in customization, the individual filters can be added/configured as well. Shown below are the default filters, as an example.</p> <blockquote><p>This is by default, do <em>NOT</em> configure this unless you have a reason to change the behavior.</p></blockquote> <div class="language-cs extra-class"><pre class="language-cs"><code>cfg<span class="token punctuation">.</span><span class="token function">ReceiveEndpoint</span><span class="token punctuation">(</span><span class="token string">&quot;input-queue&quot;</span><span class="token punctuation">,</span> ec <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    ec<span class="token punctuation">.</span><span class="token function">ConfigureDeadLetter</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        x<span class="token punctuation">.</span><span class="token function">UseFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">DeadLetterTransportFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/MassTransit/MassTransit/edit/develop/docs/usage/exceptions.md" target="_blank" rel="noopener noreferrer">Help us by improving this page!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/24/2022, 7:10:01 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      
      <a href="/usage/producers.html" class="prev">
        Producers
      </a></span> <span class="next"><a href="/usage/requests.html">
        Requests
      </a>
      
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.0f717998.js" defer></script><script src="/assets/js/3.da322882.js" defer></script><script src="/assets/js/120.cccb363a.js" defer></script>
  </body>
</html>
